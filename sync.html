<!DOCTYPE html>
<html lang="es">
<head>
    <script src="https://unpkg.com/@owlbear-rodeo/sdk/dist/obr.js"></script>
    <style>
        body { 
            background: #000; color: #444; 
            font-family: monospace; font-size: 10px; 
            margin: 0; padding: 10px; 
            display: flex; flex-direction: column; height: 100vh;
        }
        .status { color: #bb86fc; font-weight: bold; margin-bottom: 5px; }
        .log-mini { color: #666; overflow: hidden; }
    </style>
</head>
<body>
    <div class="status">● MY DASH SYNC ACTIVE</div>
    <div id="status-text">Conectando con la escena...</div>
    <div class="log-mini" id="mini-log"></div>

    <script>
        // MISMAS CLAVES QUE EL INDEX
        const DB = "VPLAT_V3_ITEMS", LG = "VPLAT_V3_LOGS", OF = "VPLAT_V3_FOLDERS";

        async function initSync() {
            await OBR.onReady(async () => {
                document.getElementById('status-text').innerText = "Sincronizado con Owlbear Rodeo";

                // ESCUCHA CAMBIOS
                OBR.scene.onMetadataChange((m) => {
                    const logs = m[LG] || [];
                    if (logs.length > 0) {
                        const last = logs[0];
                        document.getElementById('mini-log').innerText = `Última acción: ${last.u} lanzó ${last.f}`;
                    }

                    // AUTO-MANTENIMIENTO: 
                    // Si los logs superan los 20, el sync los recorta para que la partida no pese mucho
                    if (logs.length > 20) {
                        const trimmedLogs = logs.slice(0, 15);
                        OBR.scene.setMetadata({ [LG]: trimmedLogs });
                        console.log("Sync: Limpieza de logs realizada.");
                    }
                });
            });
        }

        initSync();
    </script>
</body>
</html>
