<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <script src="https://unpkg.com/@owlbear-rodeo/sdk/dist/obr.js"></script>
    <style>
        :root { --p: #bb86fc; --bg: #0d0d0f; --accent: #03dac6; }
        body { 
            background: var(--bg); 
            color: var(--t); 
            font-family: 'Segoe UI', sans-serif; 
            margin: 0; 
            padding: 15px; 
            display: flex; 
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        .status { font-size: 10px; color: var(--accent); border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 10px; display: flex; justify-content: space-between; }
        .log-container { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .log-card { background: #16161a; border-left: 3px solid var(--p); padding: 8px; border-radius: 4px; animation: fadeIn 0.3s ease; }
        .log-header { display: flex; justify-content: space-between; font-weight: bold; font-size: 14px; }
        .log-formula { font-size: 11px; color: #666; display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div class="status">
        <span>üõ∞Ô∏è NODO DE DATOS MYDASH</span>
        <span id="sync-dot">üü¢ ONLINE</span>
    </div>
    <div id="live-feed" class="log-container">
        <div style="color:#444; text-align:center; margin-top:20px;">Esperando actividad...</div>
    </div>

    <script>
        // Claves id√©nticas a MyDash para asegurar compatibilidad
        const DB = "VPLAT_V3_ITEMS";
        const LG = "VPLAT_V3_LOGS";

        OBR.onReady(async () => {
            const feed = document.getElementById('live-feed');
            const dot = document.getElementById('sync-dot');

            // FUNCI√ìN DE RENDERIZADO DE ACTIVIDAD
            const updateFeed = (logs) => {
                if (!logs || logs.length === 0) return;
                feed.innerHTML = logs.map(l => `
                    <div class="log-card">
                        <div class="log-header">
                            <span style="color:var(--p)">${l.u}</span>
                            <span style="color:#fff">${l.r}</span>
                        </div>
                        <span class="log-formula">${l.f}</span>
                    </div>
                `).join('');
            };

            // ESCUCHA ACTIVA: Este es el motor de sincronizaci√≥n
            OBR.scene.onMetadataChange((metadata) => {
                // 1. Si cambian los logs, actualizamos el feed visual
                if (metadata[LG]) {
                    updateFeed(metadata[LG]);
                }

                // 2. Si cambian los √≠tems (ediciones de los jugadores), 
                // hacemos que el punto brille para confirmar la recepci√≥n
                dot.style.filter = "brightness(2)";
                setTimeout(() => { dot.style.filter = "brightness(1)"; }, 300);

                // IMPORTANTE: Al detectar el cambio de metadatos aqu√≠, 
                // Owlbear se asegura de que la escena est√© sincronizada para todos.
                console.log("Sincronizaci√≥n de escena completada.");
            });

            // Carga inicial al abrir el addon
            const data = await OBR.scene.getMetadata();
            if (data[LG]) updateFeed(data[LG]);
        });
    </script>
</body>
</html>
