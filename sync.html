<!DOCTYPE html>
<html lang="es">
<head>
    <script src="https://unpkg.com/@owlbear-rodeo/sdk/dist/obr.js"></script>
</head>
<body style="background:#0d0d0f; color:#bb86fc; font-family:sans-serif; display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; margin:0; text-align:center;">
    
    <div id="status" style="font-weight:bold; letter-spacing:2px; text-shadow: 0 0 10px #bb86fc;">CONECTANDO NODO DE DATOS...</div>
    <div id="info" style="font-size:10px; color:#555; margin-top:10px;">VIGILANDO: VPLAT_V3_ITEMS & LOGS</div>

    <script>
        const DB = "VPLAT_V3_ITEMS";
        const LG = "VPLAT_V3_LOGS";
        const OF = "VPLAT_V3_FOLDERS";

        async function startSync() {
            try {
                await OBR.onReady(async () => {
                    document.getElementById('status').innerText = "NODO SYNC ACTIVO";
                    document.getElementById('status').style.color = "#03dac6";

                    // 1. ESCUCHA ACTIVA PARA TODOS LOS JUGADORES
                    // Cada vez que alguien edita en MyDash, este evento lo detecta para todos
                    OBR.scene.onMetadataChange((metadata) => {
                        console.log("Sync: Cambio global detectado.");
                        
                        // Notificamos visualmente que hubo tráfico de datos
                        document.body.style.background = "#16161a";
                        setTimeout(() => { document.body.style.background = "#0d0d0f"; }, 100);
                        
                        // Si el log cambia, podemos forzar un evento personalizado si fuera necesario
                        if (metadata[LG]) {
                            console.log("Sync: Nuevo log registrado por " + metadata[LG][0]?.u);
                        }
                    });

                    // 2. VERIFICACIÓN DE INTEGRIDAD
                    // Si el addon se abre y la escena está vacía, intenta recuperar
                    const currentData = await OBR.scene.getMetadata();
                    if (!currentData[DB]) {
                        console.warn("Sync: No hay datos en la escena actual.");
                    }
                });
            } catch (e) {
                document.getElementById('status').innerText = "ERROR DE CONEXIÓN";
                document.getElementById('status').style.color = "#ff4466";
            }
        }

        startSync();
    </script>
</body>
</html>
