<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/@owlbear-rodeo/sdk"></script>
    <style>
        :root { --primary: #bb86fc; --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --accent: #03dac6; --crit: #00ff00; --fumble: #ff4444; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; }
        
        /* Barra de Herramientas */
        .toolbar { display: flex; gap: 5px; background: #2c2c2c; padding: 5px; border-radius: 6px 6px 0 0; border: 1px solid #444; flex-wrap: wrap; }
        .tool-btn { background: #444; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold; }
        .tool-btn:hover { background: var(--primary); color: black; }

        textarea { background: #1a1a1a; border: 1px solid #444; border-top: none; color: white; padding: 10px; border-radius: 0 0 6px 6px; width: 100%; box-sizing: border-box; font-family: monospace; resize: vertical; }
        
        /* Estilos de la Lista y Botones */
        .dash-button { background: var(--card); padding: 15px; margin: 10px 0; border-radius: 8px; display: block; width: 100%; text-align: left; border: 1px solid #333; color: var(--text); font-size: 16px; cursor: pointer; }
        .dash-button:hover { border-color: var(--primary); }

        /* Dados y Stats */
        #preview-area { background: #1a1a1a; padding: 15px; border-radius: 8px; border: 1px dashed #555; margin-top: 10px; line-height: 1.6; }
        .dice-roll { color: var(--primary); font-weight: bold; cursor: pointer; text-decoration: underline; padding: 2px 4px; background: rgba(187,134,252,0.1); border-radius: 4px; }
        .stat-tag { color: var(--accent); font-weight: bold; }
        
        /* Caja de Resultado de Dados */
        .result-box { background: #000; padding: 15px; border: 2px solid var(--primary); margin-top: 15px; border-radius: 8px; animation: slideIn 0.2s; }
        .dice-faces { font-size: 1.2em; letter-spacing: 2px; margin: 5px 0; }
        .crit { color: var(--crit); font-weight: bold; text-shadow: 0 0 5px var(--crit); }
        .fumble { color: var(--fumble); font-weight: bold; text-shadow: 0 0 5px var(--fumble); }
        @keyframes slideIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="view-list">
        <h2 style="color:var(--primary)">Mis Dashes</h2>
        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <input type="text" id="dashName" placeholder="Nombre..." style="background:#2c2c2c; border:1px solid #444; color:white; padding:10px; border-radius:6px; flex-grow:1;">
            <button onclick="createDash()" style="background:var(--primary); border:none; padding:10px; border-radius:6px; font-weight:bold; cursor:pointer;">+ CREAR</button>
        </div>
        <div id="list-container"></div>
    </div>

    <div id="view-details" style="display:none;">
        <div style="display:flex; justify-content: space-between; margin-bottom:10px;">
            <button onclick="showList()" style="background:#444; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">‚¨Ö Volver</button>
            <h3 id="current-title" style="margin:0; color:var(--primary);"></h3>
            <div></div>
        </div>

        <div class="toolbar">
            <button class="tool-btn" onclick="insertText('**','**')">B</button>
            <button class="tool-btn" onclick="insertText('*','*')">I</button>
            <button class="tool-btn" onclick="insertText('__','__')">U</button>
            <button class="tool-btn" onclick="insertText('# ','')">H1</button>
            <button class="tool-btn" onclick="insertText('STAT=0','')">Variable</button>
            <button class="tool-btn" onclick="insertText('1d20+','')">Dado</button>
        </div>
        <textarea id="editor" rows="10" oninput="handleUpdate()"></textarea>
        
        <div id="preview-area"></div>
        <div id="dice-output"></div>
    </div>

    <script>
        let state = { dashes: {}, currentId: null, stats: {} };
        const STORAGE_KEY = "dash_plus_v2";

        async function init() {
            if (typeof OBR !== "undefined" && window.location.hostname.includes("owlbear")) {
                OBR.onReady(async () => {
                    const meta = await OBR.scene.getMetadata();
                    state.dashes = meta["com.dash.data"] || {};
                    renderList();
                });
            } else {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) state.dashes = JSON.parse(saved);
                renderList();
            }
        }

        function insertText(before, after) {
            const el = document.getElementById('editor');
            const start = el.selectionStart;
            const end = el.selectionEnd;
            const text = el.value;
            el.value = text.substring(0, start) + before + text.substring(start, end) + after + text.substring(end);
            handleUpdate();
        }

        function createDash() {
            const name = document.getElementById('dashName').value;
            if(!name) return;
            const id = "d" + Date.now();
            state.dashes[id] = { name, content: "FUE=10\nINT=5\n\nAtaque: 1d20+FUE\nHechizo: 2d9+(INT*2)" };
            document.getElementById('dashName').value = '';
            save();
        }

        function renderList() {
            const container = document.getElementById('list-container');
            container.innerHTML = '';
            Object.keys(state.dashes).forEach(id => {
                const btn = document.createElement('button');
                btn.className = 'dash-button';
                btn.innerText = "üìÇ " + state.dashes[id].name;
                btn.onclick = () => openDash(id);
                container.appendChild(btn);
            });
        }

        function openDash(id) {
            state.currentId = id;
            document.getElementById('view-list').style.display = 'none';
            document.getElementById('view-details').style.display = 'block';
            document.getElementById('current-title').innerText = state.dashes[id].name;
            document.getElementById('editor').value = state.dashes[id].content;
            processContent(state.dashes[id].content);
        }

        function handleUpdate() {
            const content = document.getElementById('editor').value;
            state.dashes[state.currentId].content = content;
            processContent(content);
            save();
        }

        async function save() {
            if (typeof OBR !== "undefined" && OBR.isReady) {
                await OBR.scene.setMetadata({ "com.dash.data": state.dashes });
            } else {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state.dashes));
                renderList();
            }
        }

        function processContent(text) {
            state.stats = {};
            // Captura variables
            text.replace(/([A-Z]+)\s*=\s*(\d+)/gi, (m, name, val) => {
                state.stats[name.toUpperCase()] = parseInt(val);
            });

            // Renderiza preview
            let html = text
                .replace(/([A-Z]+)\s*=\s*(\d+)/gi, '<span class="stat-tag">$1=$2</span>')
                .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
                .replace(/#(.*?)(\n|$)/g, '<h2>$1</h2>')
                .replace(/(\d*d\d+[\+\-\*\/A-Z0-9\(\)]*)/gi, (f) => `<span class="dice-roll" onclick="roll('${f}')">${f}</span>`);
            
            document.getElementById('preview-area').innerHTML = html.replace(/\n/g, '<br>');
        }

        function roll(formula) {
            let f = formula.toUpperCase();
            // Reemplazar variables FUE, INT, etc.
            Object.keys(state.stats).forEach(s => {
                f = f.replace(new RegExp(`\\b${s}\\b`, 'g'), state.stats[s]);
            });

            const diceMatch = f.match(/(\d*)D(\d+)/i);
            if (!diceMatch) return;

            const n = parseInt(diceMatch[1]) || 1;
            const sides = parseInt(diceMatch[2]);
            let rolls = [];
            let diceSum = 0;

            for(let i=0; i<n; i++) {
                const r = Math.floor(Math.random() * sides) + 1;
                diceSum += r;
                let style = r === sides ? 'crit' : (r === 1 ? 'fumble' : '');
                rolls.push(`<span class="${style}">${r}</span>`);
            }

            let final;
            let mathPart = f.replace(diceMatch[0], "");
            try {
                // El eval ahora soporta par√©ntesis porque mathPart los incluye
                final = eval(diceSum + mathPart.replace(/[^0-9\+\-\*\/\(\)]/g, ''));
            } catch { final = diceSum; }

            document.getElementById('dice-output').innerHTML = `
                <div class="result-box" onclick="this.innerHTML=''">
                    <div style="color:var(--primary); font-size:12px;">F√≥rmula: ${formula}</div>
                    <div class="dice-faces">[ ${rolls.join(', ')} ] ${mathPart}</div>
                    <div style="font-size:24px; font-weight:bold;">TOTAL: ${final}</div>
                    <div style="font-size:10px; color:#555; margin-top:5px;">(Clic para cerrar)</div>
                </div>`;
        }

        function showList() {
            state.currentId = null;
            document.getElementById('view-list').style.display = 'block';
            document.getElementById('view-details').style.display = 'none';
        }

        init();
    </script>
</body>
</html>
