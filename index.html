<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Dashboard Plus</title>
<script src="https://unpkg.com/@owlbear-rodeo/sdk/dist/obr.js"></script>

<style>
:root{
  --bg:#0d0d0f;--c:#1a1a1d;--p:#bb86fc;
  --t:#eee;--ok:#00ff88;--bad:#ff4466;--acc:#03dac6
}
body{margin:0;font-family:Segoe UI;background:var(--bg);color:var(--t)}
button{cursor:pointer}
.hidden{display:none}

.item{padding:10px;border:1px solid #333;border-radius:8px;margin:6px 0;background:var(--c)}
.item:hover{border-color:var(--p)}
textarea,input{background:#111;color:#eee;border:1px solid #333;border-radius:6px;padding:8px}

.dice-pop{
 position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
 background:#111;border:2px solid var(--p);
 padding:20px;border-radius:14px;z-index:99;text-align:center
}
.c-max{color:var(--ok);font-weight:bold}
.c-min{color:var(--bad);font-weight:bold}
.log{font-size:11px;border-bottom:1px solid #222;padding:4px}
</style>
</head>

<body>

<div id="listView">
  <h2>ğŸ“Š Dashboard+</h2>
  <input id="dashName" placeholder="Nuevo Dash">
  <button onclick="createDash()">â• Crear</button>
  <div id="dashList"></div>
</div>

<div id="dashView" class="hidden">
  <button onclick="back()">â¬… Volver</button>
  <h3 id="dashTitle"></h3>
  <button id="editBtn" onclick="toggleEdit()">âœ Editar</button>

  <div id="editorBox" class="hidden">
    <textarea id="editor" rows="10" oninput="saveDash()"></textarea>
  </div>

  <div id="preview"></div>

  <h4>â˜‘ ExtraCasilla+</h4>
  <input id="extraInput" placeholder="Texto / dados">
  <button onclick="addExtra()">âœ”</button>

  <h4>ğŸ“œ Log Global</h4>
  <button onclick="clearLog()">ğŸ—‘ Reset (GM)</button>
  <div id="logBox"></div>
</div>

<div id="dicePop" class="dice-pop hidden"></div>

<script>
/* ===================== CONFIG ===================== */
const DASH_KEY="dashplus.dashes.v3";
const LOG_KEY="dashplus.log.v3";

/* ===================== STATE ===================== */
let S={
 dashes:{},log:[],dash:null,
 user:{id:"local",name:"Web",role:"PLAYER"},
 edit:false
};

/* ===================== INIT ===================== */
async function init(){
 try{
  await OBR.onReady(async()=>{
   S.user.id=await OBR.player.getId();
   S.user.name=await OBR.player.getName();
   S.user.role=await OBR.player.getRole();

   const m=await OBR.scene.getMetadata();
   S.dashes=m[DASH_KEY]||{};
   S.log=m[LOG_KEY]||[];

   OBR.scene.onMetadataChange(mm=>{
    S.dashes=mm[DASH_KEY]||{};
    S.log=mm[LOG_KEY]||[];
    renderList();renderLog();
    if(S.dash)renderDash();
   });
   renderList();renderLog();
  });
 }catch{
  S.dashes=JSON.parse(localStorage.getItem(DASH_KEY)||"{}");
  S.log=JSON.parse(localStorage.getItem(LOG_KEY)||"[]");
  renderList();renderLog();
 }
}
init();

/* ===================== SAVE ===================== */
async function save(){
 try{
  const m=await OBR.scene.getMetadata();
  m[DASH_KEY]=S.dashes;m[LOG_KEY]=S.log;
  await OBR.scene.setMetadata(m);
 }catch{
  localStorage.setItem(DASH_KEY,JSON.stringify(S.dashes));
  localStorage.setItem(LOG_KEY,JSON.stringify(S.log));
 }
}

/* ===================== DASH ===================== */
function createDash(){
 const n=dashName.value||"Nuevo";
 const id="d"+Date.now();
 S.dashes[id]={
  id,name:n,content:"",
  owner:S.user.id,
  users:{}
 };
 dashName.value="";
 save();
}

function renderList(){
 dashList.innerHTML="";
 Object.values(S.dashes).forEach(d=>{
  const div=document.createElement("div");
  div.className="item";
  div.innerText=d.name;
  div.onclick=()=>openDash(d.id);
  dashList.appendChild(div);
 });
}

function openDash(id){
 S.dash=id;
 listView.classList.add("hidden");
 dashView.classList.remove("hidden");
 renderDash();
}

function back(){
 S.dash=null;
 dashView.classList.add("hidden");
 listView.classList.remove("hidden");
}

function renderDash(){
 const d=S.dashes[S.dash];
 dashTitle.innerText=d.name;
 editor.value=d.content;
 editBtn.style.display=canEdit(d)?"block":"none";
 editorBox.classList.toggle("hidden",!S.edit);
 renderPreview(d);
}

function toggleEdit(){
 S.edit=!S.edit;
 renderDash();
}

function saveDash(){
 S.dashes[S.dash].content=editor.value;
 save();
}

/* ===================== PERMS ===================== */
function canEdit(d){
 return S.user.role==="GM"||d.owner===S.user.id;
}

/* ===================== EXTRA ===================== */
function addExtra(){
 const v=extraInput.value;
 if(!v)return;
 const d=S.dashes[S.dash];
 d.users[S.user.id]=(d.users[S.user.id]||"")+"\n"+v;
 extraInput.value="";
 save();
}

/* ===================== PREVIEW ===================== */
function renderPreview(d){
 let txt=d.content+"\n"+(d.users[S.user.id]||"");
 let vars={};
 txt.replace(/([A-Z]+)\s*=\s*(\d+)/g,(_,k,v)=>vars[k]=+v);

 let html=txt.replace(/(\d*d\d+[A-Z0-9+\-*()/]*)/gi,f=>{
  return `<span style="color:var(--p);cursor:pointer" onclick="roll('${f}')">${f}</span>`;
 });

 preview.innerHTML=html.replace(/\n/g,"<br>");
}

/* ===================== DICE ===================== */
function roll(f){
 let d=S.dashes[S.dash];
 let txt=d.content+(d.users[S.user.id]||"");
 let vars={};
 txt.replace(/([A-Z]+)\s*=\s*(\d+)/g,(_,k,v)=>vars[k]=+v);

 let exp=f.replace(/[A-Z]+/g,m=>vars[m]??0);
 let m=exp.match(/(\d*)d(\d+)/i);
 if(!m)return;

 let n=+m[1]||1,s=+m[2],r=[],sum=0;
 for(let i=0;i<n;i++){
  let v=Math.floor(Math.random()*s)+1;
  r.push(v);sum+=v;
 }

 let res;
 try{res=eval(exp.replace(m[0],sum));}
 catch{res=sum;}

 showDice(f,r,res);
 logRoll(f,r,res);
}

function showDice(f,r,res){
 dicePop.innerHTML=`<b>${f}</b><br>
 ${r.map(v=>`<span class="${v==1?'c-min':v==Math.max(...r)?'c-max':''}">${v}</span>`).join(", ")}
 <h1>${res}</h1>`;
 dicePop.classList.remove("hidden");
 setTimeout(()=>dicePop.classList.add("hidden"),2500);
}

/* ===================== LOG ===================== */
function logRoll(f,r,res){
 S.log.unshift({
  u:S.user.name,f,r,res,t:new Date().toLocaleTimeString()
 });
 S.log=S.log.slice(0,30);
 save();
}

function renderLog(){
 logBox.innerHTML=S.log.map(l=>
  `<div class="log"><b>${l.u}</b> ${l.f} â†’ ${l.res}</div>`
 ).join("");
}

function clearLog(){
 if(S.user.role!=="GM")return;
 S.log=[];save();
}
</script>
</body>
</html>
