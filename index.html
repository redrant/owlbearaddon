<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Star Dash Platinum - Owlbear Addon</title>
  <script src="https://unpkg.com/@owlbear-rodeo/sdk/dist/obr.js"></script>
  <style>
    :root { --p:#bb86fc; --bg:#0d0d0f; --surf:#16161a; --t:#f0f0f0; --accent:#03dac6; --crit:#00ff88; --fail:#ff4466; --var:#ffab40; --dice-bg:#2d2d3d; }
    * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
    body { background: var(--bg); color: var(--t); margin:0; height:100vh; display:flex; flex-direction:column; overflow:hidden; }
    .header { padding:12px; text-align:center; border-bottom:1px solid #333; background: var(--surf); flex-shrink:0; }
    .sig { font-size:14px; font-weight:700; color:var(--p); text-shadow:0 0 10px var(--p); letter-spacing:2px; }

    #view-list { flex:1; display:flex; flex-direction:column; padding:15px; gap:10px; overflow:auto; }
    #view-details { display:none; flex-direction:column; padding:15px; gap:10px; }

    .items-area { flex:1; overflow:auto; display:flex; flex-direction:column; gap:6px; }
    .card { padding:12px; background:var(--surf); border-radius:10px; border:1px solid #252529; display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
    .folder { border-left:5px solid var(--var); font-weight:700; }
    .dash { border-left:5px solid var(--p); }

    .tool { background:#333; color:white; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; font-size:12px; font-weight:bold; }
    .btn-dice { background:var(--dice-bg); border:1px solid #333; border-bottom:3px solid var(--p); color:var(--p); padding:8px 14px; border-radius:8px; font-weight:900; cursor:pointer; }
    .btn-dice[disabled] { opacity:.6; cursor:not-allowed; }

    .log { height:110px; background:#000; padding:10px; font-size:11px; border-radius:10px; border:1px solid #222; overflow:auto; color:#888; }

    .overlay { position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,.9); display:none; align-items:center; justify-content:center; z-index:10000; }
    .modal { background:#111; border:2px solid var(--p); padding:25px; border-radius:20px; width:90%; max-width:450px; text-align:center; }
    .dice-display { display:flex; justify-content:center; gap:10px; flex-wrap:wrap; margin:20px 0; min-height:60px; }
    .die-num { font-size:34px; padding:10px; border-radius:10px; background:#1a1a1d; border:1px solid #333; }
    .total-box { font-size:72px; font-weight:900; color:var(--p); opacity:0; transition:opacity .5s; text-shadow:0 0 20px var(--p); }
    .total-box.show { opacity:1; }

  </style>
</head>
<body>

  <div class="header"><div class="sig">My Star Dash Platinum v1</div></div>

  <div id="view-list">
    <div style="display:flex; gap:8px;">
      <input type="text" id="newName" placeholder="Nombre..." style="flex:1; padding:10px; background:#1a1a1d; border:1px solid #333; color:white; border-radius:8px;">
      <button onclick="newItem('dash')" class="tool" style="background:var(--p); color:black;">+DASH</button>
      <button onclick="newItem('folder')" class="tool" style="background:var(--var); color:black;">+CARPETA</button>
    </div>
    <div id="items-container" class="items-area" aria-label="Lista de items"></div>
    <div class="log" id="log-content" aria-live="polite"></div>
  </div>

  <div id="view-details" aria-label="Detalle">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <button onclick="goBack()" class="btn-dice">⬅ VOLVER</button>
      <b id="det-title" style="color:var(--p)"></b>
      <button id="own-btn" onclick="toggleOwnership()" class="btn-dice">OCUPAR</button>
    </div>
    <div style="display:flex; gap:6px; margin-top:8px;">
      <button id="t-view" onclick="switchTab(false)" class="btn-dice" style="flex:1;">VER</button>
      <button id="t-edit" onclick="switchTab(true)" class="btn-dice" style="flex:1;">EDITAR</button>
    </div>
    <div id="editor-ui" style="display:none; flex-direction:column; flex:1; margin-top:8px;">
      <textarea id="editor" oninput="updateContent()" style="width:100%; height:180px; background:#000; color:#ddd; border:1px solid #444; padding:10px;"></textarea>
      <div id="preview" style="display:none; padding:8px; background:#111; border:1px solid #333; color:#ddd; margin-top:6px;"></div>
    </div>
  </div>

  <div id="dice-overlay" class="overlay" onclick="this.style.display='none'">
    <div class="modal" onclick="event.stopPropagation()">
      <div id="d-f" style="color:#555; font-size:12px; font-family: monospace;"></div>
      <div id="dice-container" class="dice-display"></div>
      <div id="total-val" class="total-box">0</div>
      <div id="d-res" style="color:#777; font-size:13px; border-top:1px solid #222; padding-top:10px; margin-top:10px;"></div>
    </div>
  </div>

  <div id="note-overlay" class="overlay" onclick="this.style.display='none'">
    <div class="modal" onclick="event.stopPropagation()" style="border-color: var(--accent);">
      <h2 id="note-title" style="color:var(--accent); margin-top:0;"></h2>
      <div id="note-body" style="text-align:left; color:#ccc; white-space: pre-wrap; line-height:1.6;"></div>
      <button onclick="document.getElementById('note-overlay').style.display='none'" class="btn-dice" style="width:100%; margin-top:20px; border-color:var(--accent); color:var(--accent);">CERRAR</button>
    </div>
  </div>

  <script>
    // Estado local
    let state = { items: {}, log: [], id: null, uid: 'local', uname: 'Player', openFolders: {} };
    const DB = "VPLAT_V3_ITEMS", LG = "VPLAT_V3_LOGS", OF = "VPLAT_V3_FOLDERS";

    async function init() {
      if (!window.OBR) {
        render();
        return;
      }
      try {
        await OBR.onReady(async () => {
          state.uid = await OBR.player.getId();
          state.uname = await OBR.player.getName();
          OBR.scene.onMetadataChange(m => {
            state.items = m[DB] || {};
            state.log = m[LG] || [];
            state.openFolders = m[OF] || {};
            render();
          });
          const m = await OBR.scene.getMetadata();
          state.items = m[DB] || {};
          state.log = m[LG] || [];
          state.openFolders = m[OF] || {};
          render();
        });
      } catch (e) {
        console.warn('No ROS ready:', e);
      }
    }

    async function save() {
      if (!window.OBR) { render(); return; }
      await OBR.scene.setMetadata({ [DB]: state.items, [LG]: state.log, [OF]: state.openFolders });
      render();
    }

    // Crear item (dash o folder)
    function newItem(type) {
      const nombre = document.getElementById('newName').value.trim() || (type==='dash' ? "Nuevo Dash" : "Nueva Carpeta");
      const id = (type === 'dash' ? 'dash_' : 'fld_') + Date.now();
      state.items[id] = { id, type, name: nombre, content: '', parent: null, owner: null };
      document.getElementById('newName').value = "";
      // Guardar y renderizar
      save();
    }

    function render() {
      const cont = document.getElementById('items-container');
      if (!cont) return;
      cont.innerHTML = "";
      const items = Object.values(state.items);

      // Mostrar carpetas primero
      const folders = items.filter(i => i.type === 'folder');
      const dashes  = items.filter(i => i.type === 'dash');

      const addCard = (it) => {
        const el = document.createElement('div');
        el.className = 'card ' + (it.type === 'folder' ? 'folder' : 'dash');
        el.innerHTML = `
          <div style="display:flex; align-items:center; gap:8px;">
            <span style="width:8px; height:8px; border-radius:50%; background:${it.type==='folder'?'var(--var)':'var(--p)'}"></span>
            <span>${escapeHtml(it.name)}</span>
            ${it.owner ? `<span class="block-var" title="Propietario">Dueño: ${escapeHtml(it.owner)}</span>`: ''}
          </div>
          <div>
            <button class="tool" onclick="openDetail('${it.id}')" title="Ver/Editar">Abrir</button>
          </div>
        `;
        cont.appendChild(el);
      };

      folders.forEach(addCard);
      dashes.forEach(addCard);

      // Log
      const logEl = document.getElementById('log-content');
      logEl.innerHTML = state.log.map(e => `[${new Date(e.ts).toLocaleTimeString()}] ${escapeHtml(e.user)}: ${escapeHtml(e.msg)}`).join('<br/>');
    }

    function openDetail(id) {
      state.id = id;
      const item = state.items[id];
      if (!item) return;
      document.getElementById('det-title').textContent = item.name;
      updateOwnershipButton(item);
      // Mostrar detalle
      document.getElementById('view-details').style.display = 'block';
      document.getElementById('view-list').style.display = 'none';
      // Editor
      switchTab(false);
      const editor = document.getElementById('editor');
      if (editor) editor.value = item.content || "";
    }

    function goBack() {
      document.getElementById('view-details').style.display = 'none';
      document.getElementById('view-list').style.display = 'flex';
      state.id = null;
    }

    function updateOwnershipButton(item) {
      const btn = document.getElementById('own-btn');
      if (!btn || !item) return;
      if (!item.owner) {
        btn.textContent = 'OWNEAR';
        btn.disabled = false;
        btn.className = 'btn-dice';
      } else if (item.owner === state.uid) {
        btn.textContent = 'LIBERAR';
        btn.disabled = false;
        btn.className = 'btn-dice btn-owner-true';
      } else {
        btn.textContent = `Ver (dueño: ${escapeHtml(item.owner)})`;
        btn.disabled = true;
        btn.className = 'btn-dice btn-owner-false';
      }
    }

    function toggleOwnership() {
      const id = state.id;
      const item = state.items[id];
      if (!id || !item) return;

      // Si no tiene owner, asigna a current
      if (!item.owner) {
        item.owner = state.uid;
        addLog(`${state.uname} owneó "${item.name}"`);
      } else if (item.owner === state.uid) {
        item.owner = null;
        addLog(`"${item.name}" ya no tiene dueño`);
      } else {
        // no debería ocurrir por UI
      }
      save();
      updateOwnershipButton(item);
    }

    function switchTab(showEditor) {
      state.edit = showEditor;
      const editorUI = document.getElementById('editor-ui');
      const preview = document.getElementById('preview');
      if (editorUI) editorUI.style.display = showEditor ? 'flex' : 'none';
      if (preview) preview.style.display = showEditor ? 'block' : 'none';
    }

    function updateContent() {
      const id = state.id;
      if (!id) return;
      state.items[id].content = document.getElementById('editor').value;
      save();
    }

    function addLog(message) {
      state.log.unshift({ ts: Date.now(), user: state.uname, msg: message });
      if (state.log.length > 200) state.log = state.log.slice(0,200);
      save();
    }

    function escapeHtml(s) {
      return String(s ?? '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    }

    window.addEventListener('DOMContentLoaded', () => {
      init();
      // Exponer tirada simple para pruebas
      window.rollDice = function(sides=6, count=1) {
        const results = [];
        for (let i=0;i<count;i++) results.push(Math.floor(Math.random()*sides)+1);
        addLog(`Tirada ${count}d${sides} de ${state.uname}: [${results.join(', ')}]`);
        // mostrar overlay opcional
        showDice(results);
        return results;
      };
    });

    function showDice(results) {
      const overlay = document.getElementById('dice-overlay');
      const container = document.getElementById('dice-container');
      const total = document.getElementById('total-val');
      const dRes = document.getElementById('d-res');
      container.innerHTML = '';
      let sum = 0;
      results.forEach(v => { sum += v; const d = document.createElement('div'); d.className='die-num'; d.textContent = v; container.appendChild(d); });
      total.textContent = sum;
      total.classList.add('show');
      dRes.textContent = 'Total: ' + sum;
      overlay.style.display = 'flex';
      setTimeout(() => overlay.style.display = 'none', 2000);
    }

  </script>
</body>
</html>
