<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <script src="https://unpkg.com/@owlbear-rodeo/sdk/dist/obr.js"></script>
    <style>
        :root { 
            --p: #bb86fc; --bg: #0d0d0f; --c: #1a1a1d; --t: #f0f0f0; 
            --accent: #03dac6; --crit: #00ff88; --fail: #ff4466; --folder: #ff9800;
        }
        
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--t); margin: 0; padding: 10px; user-select: none; }
        
        /* Est√©tica General */
        .header-main { text-align: center; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .version { font-size: 9px; color: var(--p); font-weight: bold; letter-spacing: 2px; }
        .signature { font-size: 15px; font-weight: bold; text-shadow: 0 0 10px var(--p); color: var(--p); }

        .toolbar { display: flex; gap: 4px; background: #1e1e1e; padding: 8px; border-radius: 8px 8px 0 0; border: 1px solid #333; flex-wrap: wrap; }
        .tool { background: #2d2d30; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 11px; font-weight: 600; }
        .tool:hover { background: var(--p); color: black; }

        #editor { width: 100%; height: 280px; background: #0f0f11; color: #aaa; padding: 15px; border: 1px solid #333; border-top: none; font-family: 'Consolas', monospace; resize: vertical; box-sizing: border-box; outline: none; line-height: 1.5; }
        #preview { padding: 20px; min-height: 120px; display: none; background: rgba(255,255,255,0.02); border-radius: 0 0 10px 10px; line-height: 1.8; border: 1px solid #333; border-top: none; }

        /* Listas y Carpetas */
        .item-card { padding: 12px; margin-bottom: 6px; border-radius: 8px; border: 1px solid #252529; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: #16161a; }
        .dash-item { border-left: 4px solid var(--p); }
        .folder-item { background: #1d170e; border-left: 4px solid var(--folder); color: var(--folder); font-weight: bold; }
        .folder-toggle { background: rgba(255,255,255,0.1); border: none; color: white; border-radius: 4px; padding: 2px 6px; margin-right: 8px; cursor: pointer; }

        /* CASILLA PLUS: El dise√±o que pediste */
        .cb-container { display: flex; align-items: flex-start; background: rgba(3, 218, 198, 0.05); padding: 10px; border-radius: 8px; margin: 8px 0; border: 1px solid rgba(3, 218, 198, 0.1); border-left: 4px solid var(--accent); }
        .cb-plus { width: 18px; height: 18px; margin: 4px 12px 0 0; cursor: pointer; accent-color: var(--accent); }
        .cb-content { flex: 1; font-size: 14px; }

        /* Notas+ */
        .note-btn { background: rgba(3, 218, 198, 0.1); color: var(--accent); border: 1px solid var(--accent); padding: 4px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold; margin: 4px 0; display: inline-block; }
        
        /* Dados con Animaci√≥n y Colores Cr√≠ticos */
        .dice-result-pop { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1a1a1d; border: 2px solid var(--p); padding: 30px; border-radius: 20px; text-align: center; z-index: 10000; box-shadow: 0 0 60px #000; animation: pop 0.2s cubic-bezier(0.17, 0.89, 0.32, 1.28); }
        @keyframes pop { from { transform: translate(-50%, -45%) scale(0.8); opacity: 0; } }
        .c-max { color: var(--crit); font-weight: bold; text-shadow: 0 0 10px var(--crit); }
        .c-min { color: var(--fail); font-weight: bold; text-shadow: 0 0 10px var(--fail); }

        /* Logs */
        .log-container { background: #000; border-radius: 10px; margin-top: 20px; border: 1px solid #222; overflow: hidden; }
        .log-header { background: #1a1a1a; padding: 6px 12px; font-size: 10px; color: #555; display: flex; justify-content: space-between; }
        #log-content { height: 120px; overflow-y: auto; padding: 10px; font-size: 12px; }
        .log-entry { padding: 4px 0; border-bottom: 1px solid #111; }

        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 9999; backdrop-filter: blur(4px); }
        .modal { background: #1a1a1d; border: 1px solid #333; padding: 25px; border-radius: 15px; width: 85%; max-width: 450px; }
    </style>
</head>
<body>

    <div id="view-list">
        <div class="header-main">
            <div class="version">VERSION 1.3.5v</div>
            <div class="signature">By Redrant :v</div>
        </div>
        
        <div class="input-group" style="display:flex; gap:5px; margin-bottom:15px;">
            <input type="text" id="itemName" placeholder="Nombre..." style="flex:1; padding:10px; background:#1a1a1d; color:white; border:1px solid #333; border-radius:8px;">
            <button onclick="createItem('dash')" class="tool" style="background:var(--p); color:black;">+DASH</button>
            <button onclick="createItem('folder')" class="tool" style="background:var(--folder); color:black;">+CARPETA</button>
        </div>

        <div id="list-container"></div>

        <div class="log-container">
            <div class="log-header"><span>HISTORIAL GLOBAL</span> <span onclick="clearLog()" style="cursor:pointer">LIMPIAR üîÑ</span></div>
            <div id="log-content"></div>
        </div>
    </div>

    <div id="view-details" style="display:none;">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom:10px;">
            <button onclick="showList()" class="tool">‚¨Ö ATR√ÅS</button>
            <div id="current-title" class="signature"></div>
            <div style="display:flex; gap:4px;">
                <button onclick="openOwnerMenu()" class="tool">üë§</button>
                <button onclick="deleteItem(state.id)" class="tool" style="background:var(--fail)">üóëÔ∏è</button>
            </div>
        </div>

        <button onclick="toggleMode()" id="btn-mode" style="width:100%; padding:12px; background:var(--p); color:black; font-weight:bold; border:none; border-radius:8px; cursor:pointer; margin-bottom:10px;">MODO JUEGO</button>

        <div id="editor-ui">
            <div class="toolbar">
                <button class="tool" onclick="wrap('**','**')">B</button>
                <button class="tool" onclick="wrap('*','*')">I</button>
                <button class="tool" onclick="promptGlow()">‚ú® Brillo</button>
                <button class="tool" onclick="ins('[note=T√çTULO]CONTENIDO[/note]','')">üìù Nota+</button>
                <button class="tool" onclick="ins('[cb] TEXTO A COPIAR','')">üîò Casilla+</button>
            </div>
            <textarea id="editor" oninput="handleInput()" placeholder="Escribe aqu√≠..."></textarea>
        </div>
        <div id="preview"></div>
    </div>

    <div id="dice-overlay" class="dice-result-pop" style="display:none;" onclick="this.style.display='none'"></div>
    <div id="global-overlay" class="overlay" onclick="this.style.display='none'"><div id="modal-content" class="modal" onclick="event.stopPropagation()"></div></div>

    <script>
        let state = { items: {}, id: null, stats: {}, editing: false, role: 'GM', userId: 'local', userName: 'User', draggedId: null, collapsed: {} };
        const KEY = "com.redrant.dashes.v135";
        const LOG_KEY = "com.redrant.dashes.log.v135";

        async function init() {
            try {
                await OBR.onReady(async () => {
                    state.role = await OBR.player.getRole();
                    state.userId = await OBR.player.getId();
                    state.userName = await OBR.player.getName();
                    OBR.scene.onMetadataChange(m => { 
                        state.items = m[KEY] || {}; 
                        renderList(); 
                        renderLog(m[LOG_KEY]||[]); 
                        if(state.id) syncView(); 
                    });
                });
            } catch(e) { loadLocal(); }
        }

        function loadLocal() {
            state.items = JSON.parse(localStorage.getItem(KEY) || "{}");
            renderList();
            renderLog(JSON.parse(localStorage.getItem(LOG_KEY) || "[]"));
        }

        async function save() {
            try { await OBR.scene.setMetadata({ [KEY]: state.items }); }
            catch(e) { localStorage.setItem(KEY, JSON.stringify(state.items)); renderList(); }
        }

        function createItem(type) {
            const n = document.getElementById('itemName').value || "Nuevo";
            const id = "i" + Date.now();
            state.items[id] = { id, type, name: n, content: type==='dash'?'# '+n:'', owner: null, parentId: null };
            document.getElementById('itemName').value = '';
            save();
        }

        function renderList() {
            const c = document.getElementById('list-container'); c.innerHTML = '';
            const items = Object.values(state.items);
            items.filter(i => i.type === 'folder').forEach(folder => {
                const isCollapsed = state.collapsed[folder.id];
                const fDiv = document.createElement('div');
                fDiv.className = 'item-card folder-item';
                fDiv.innerHTML = `<div><button class="folder-toggle" onclick="event.stopPropagation(); toggleFolder('${folder.id}')">${isCollapsed?'+':'-'}</button>üìÅ ${folder.name.toUpperCase()}</div><span onclick="event.stopPropagation(); deleteItem('${folder.id}')" style="color:var(--fail)">‚úï</span>`;
                fDiv.onclick = () => toggleFolder(folder.id);
                fDiv.ondragover = e => { e.preventDefault(); fDiv.style.borderColor = "var(--folder)"; };
                fDiv.ondragleave = () => fDiv.style.borderColor = "";
                fDiv.ondrop = e => { e.preventDefault(); moveItem(state.draggedId, folder.id); };
                c.appendChild(fDiv);
                if(!isCollapsed) items.filter(i => i.parentId === folder.id).forEach(dash => c.appendChild(createDashCard(dash, true)));
            });
            items.filter(i => i.type === 'dash' && !i.parentId).forEach(dash => c.appendChild(createDashCard(dash, false)));
        }

        function toggleFolder(fid) { state.collapsed[fid] = !state.collapsed[fid]; renderList(); }

        function createDashCard(dash, isChild) {
            const d = document.createElement('div');
            d.className = 'item-card dash-item';
            if(isChild) d.style.marginLeft = "25px";
            d.draggable = true;
            d.innerHTML = `<span>üìÑ ${dash.name}</span> ${dash.owner?'<small style="color:var(--p)">üë§</small>':''}`;
            d.ondragstart = () => state.draggedId = dash.id;
            d.onclick = () => { state.id = dash.id; openDash(); };
            return d;
        }

        async function moveItem(id, parentId) { state.items[id].parentId = parentId; await save(); }
        function deleteItem(id) { if(confirm("¬øBorrar?")) { delete state.items[id]; Object.values(state.items).forEach(i => { if(i.parentId === id) i.parentId = null; }); save(); if(state.id === id) showList(); } }

        function openDash() { document.getElementById('view-list').style.display = 'none'; document.getElementById('view-details').style.display = 'block'; state.editing = false; syncView(); }

        function syncView() {
            const item = state.items[state.id]; if(!item) return;
            document.getElementById('current-title').innerText = item.name;
            const canEdit = (state.role === 'GM' || item.owner === state.userId);
            document.getElementById('editor-ui').style.display = (state.editing && canEdit) ? 'block' : 'none';
            document.getElementById('preview').style.display = state.editing ? 'none' : 'block';
            document.getElementById('btn-mode').innerText = state.editing ? "üíæ GUARDAR DASH" : "‚úçÔ∏è EDITAR DASH";
            if(document.activeElement !== document.getElementById('editor')) document.getElementById('editor').value = item.content;
            renderPreview(item.content);
        }

        function renderPreview(txt) {
            state.stats = {};
            txt.replace(/([A-Z]+)\s*=\s*(\d+)/gi, (m, n, v) => state.stats[n.toUpperCase()] = parseInt(v));

            let html = txt
                .replace(/\*\*(.*?)\*\*/gs, '<b>$1</b>')
                .replace(/\*(.*?)\*/gs, '<i>$1</i>')
                .replace(/\[note=(.*?)\](.*?)\[\/note\]/gs, (m, t, c) => {
                    const clean = c.trim().replace(/\n\s*\n/g, '<br><div style="margin-top:8px;"></div>').replace(/\n/g, '<br>');
                    return `<button class="note-btn" onclick="showNote('${t}', '${clean.replace(/'/g, "\\'")}')">üìå ${t}</button>`;
                })
                .replace(/\[cb\]\s*(.*?)(?:\n|$)/gi, (m, content) => {
                    // Renderizamos contenido interno (brillos, etc) para visualizaci√≥n
                    const visual = content.replace(/<g=(.*?)>(.*?)<\/g>/gs, '<span style="text-shadow:0 0 10px $1; color:$1; font-weight:bold;">$2</span>');
                    return `<div class="cb-container"><input type="checkbox" class="cb-plus" onclick="handleTransfer('${content.replace(/'/g,"\\'")}', this)"> <div class="cb-content">${visual}</div></div>`;
                })
                .replace(/<g=(.*?)>(.*?)<\/g>/gs, '<span style="text-shadow:0 0 10px $1; color:$1; font-weight:bold;">$2</span>')
                .replace(/(\d*d\d+[\+\-\*\/A-Z0-9]*)/gi, f => `<span style="color:var(--p);cursor:pointer;font-weight:bold;text-decoration:underline;" onclick="roll('${f}')">${f}</span>`);

            document.getElementById('preview').innerHTML = html.replace(/\n/g, '<br>');
        }

        async function handleTransfer(textToCopy, cb) {
            if(!cb.checked) return;
            // Buscamos el Dash del que ha marcado la casilla
            const myDash = Object.values(state.items).find(i => i.owner === state.userId);
            if(myDash) {
                myDash.content += "\n" + textToCopy;
                await save();
                cb.parentElement.style.opacity = "0.4";
                cb.parentElement.style.borderLeftColor = "#555";
            } else { 
                alert("Debes asignarte un Dash (Icono üë§) para recibir la informaci√≥n."); 
                cb.checked = false; 
            }
        }

        async function roll(formula) {
            let f = formula.toUpperCase();
            Object.keys(state.stats).forEach(s => f = f.replace(new RegExp(`\\b${s}\\b`, 'g'), state.stats[s]));
            const dm = f.match(/(\d*)D(\d+)/i); if(!dm) return;
            const n = parseInt(dm[1])||1, sides = parseInt(dm[2]);
            let rolls = [], rollValues = [], sum = 0;
            for(let i=0; i<n; i++){ 
                let r = Math.floor(Math.random()*sides)+1; 
                rollValues.push(r);
                rolls.push(`<span class="${r===sides?'c-max':(r===1?'c-min':'')}">${r}</span>`); 
                sum += r; 
            }
            let res; try { res = eval(sum + f.replace(dm[0], "").replace(/[^0-9\+\-\*\/\(\)]/g, '')); } catch { res = sum; }
            const ov = document.getElementById('dice-overlay');
            ov.innerHTML = `<div style="font-size:12px;opacity:0.6;">${formula}</div><div style="font-size:1.6em;margin:15px 0;">[ ${rolls.join(', ')} ]</div><div style="font-size:42px;color:var(--accent);font-weight:bold;">${res}</div>`;
            ov.style.display = 'block';

            const logEntry = { u: state.userName, f: formula, r: res, det: rollValues, t: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) };
            try {
                const m = await OBR.scene.getMetadata();
                const logs = [logEntry, ...(m[LOG_KEY]||[])].slice(0, 30);
                await OBR.scene.setMetadata({ [LOG_KEY]: logs });
            } catch(e) {
                const logs = [logEntry, ...JSON.parse(localStorage.getItem(LOG_KEY)||"[]")].slice(0,30);
                localStorage.setItem(LOG_KEY, JSON.stringify(logs)); renderLog(logs);
            }
        }

        function renderLog(logs) {
            document.getElementById('log-content').innerHTML = logs.map(l => `<div class="log-entry"><b>${l.u}:</b> ${l.f} ‚ûî <span style="color:var(--accent)">${l.r}</span> <small style="color:#555">[${l.det.join(',')}]</small></div>`).join('');
        }

        function toggleMode() { state.editing = !state.editing; syncView(); }
        function handleInput() { state.items[state.id].content = document.getElementById('editor').value; save(); }
        function showList() { state.id = null; document.getElementById('view-list').style.display = 'block'; document.getElementById('view-details').style.display = 'none'; }
        
        function showNote(t, c) { 
            document.getElementById('modal-content').innerHTML = `<h3 style="color:var(--accent); margin-top:0;">${t}</h3><div style="text-align:left; color:#ccc; line-height:1.6;">${c}</div><button onclick="document.getElementById('global-overlay').style.display='none'" class="tool" style="width:100%; margin-top:20px; background:var(--p); color:black;">CERRAR</button>`; 
            document.getElementById('global-overlay').style.display = 'flex'; 
        }
        
        async function openOwnerMenu() {
            let h = `<h3>Asignar Due√±o</h3>`;
            try {
                const players = await OBR.party.getPlayers();
                players.forEach(p => h += `<button onclick="setOwner('${p.id}')" style="width:100%; padding:10px; margin:4px 0; background:#333; color:white; border:none; border-radius:6px;">${p.name}</button>`);
            } catch(e) { h += `<button onclick="setOwner('local')" class="tool">Local</button>`; }
            document.getElementById('modal-content').innerHTML = h;
            document.getElementById('global-overlay').style.display = 'flex';
        }

        function setOwner(uid) { state.items[state.id].owner = uid; save(); document.getElementById('global-overlay').style.display='none'; }
        function wrap(a, b) { const e = document.getElementById('editor'); const s = e.selectionStart, end = e.selectionEnd; e.value = e.value.substring(0, s) + a + e.value.substring(s, end) + b + e.value.substring(end); handleInput(); }
        function ins(a, b) { const e = document.getElementById('editor'); const s = e.selectionStart, end = e.selectionEnd; e.value = e.value.substring(0, s) + a + b + e.value.substring(end); handleInput(); }
        function promptGlow() { const c = prompt("Color:", "violet"); if(c) wrap(`<g=${c}>`, `</g>`); }
        async function clearLog() { if(confirm("¬øLimpiar?")) { try { await OBR.scene.setMetadata({ [LOG_KEY]: [] }); } catch(e) { localStorage.setItem(LOG_KEY, "[]"); renderLog([]); } } }

        init();
    </script>
</body>
</html>
