 (cd "$(git rev-parse --show-toplevel)" && git apply --3way <<'EOF' 
diff --git a/MyTrueDashPlus.html b/MyTrueDashPlus.html
index c6cc7c986fe2cad69507e7db6f7e9a05e10e1282..a00fdebe22949b047c62f4efe9d83089fa6fed43 100644
--- a/MyTrueDashPlus.html
+++ b/MyTrueDashPlus.html
@@ -101,148 +101,193 @@
             </div>
             <textarea id="editor" oninput="showSaveBtn()"></textarea>
         </div>
         <div id="preview"></div>
     </div>
 
     <div id="dice-overlay" class="overlay" onclick="this.style.display='none'">
         <div class="modal" onclick="event.stopPropagation()">
             <div id="d-f" style="color:#555; font-size:12px; font-family: monospace;"></div>
             <div id="dice-container" class="dice-display"></div>
             <div id="total-val" class="total-box">0</div>
             <div id="d-res" style="color:#777; font-size:13px; border-top: 1px solid #222; padding-top: 10px; margin-top: 10px;"></div>
         </div>
     </div>
 
     <div id="note-overlay" class="overlay" onclick="this.style.display='none'">
         <div class="modal" onclick="event.stopPropagation()" style="border-color: var(--accent);">
             <h2 id="note-title" style="color:var(--accent); margin-top:0;"></h2>
             <div id="note-body" style="text-align:left; color:#ccc; white-space: pre-wrap; line-height: 1.6; max-height: 60vh; overflow-y: auto; padding-right: 5px;"></div>
             <button onclick="document.getElementById('note-overlay').style.display='none'" class="btn-dice" style="width:100%; margin-top:20px; border-color:var(--accent); color:var(--accent); justify-content:center;">CERRAR</button>
         </div>
     </div>
 
     <script>
         let state = { items: {}, log: [], id: null, edit: false, uid: 'local', uname: 'Player', openFolders: {}, dragId: null, isModified: false };
-        const DB = "VPLAT_V3_ITEMS", LG = "VPLAT_V3_LOGS", OF = "VPLAT_V3_FOLDERS";
+        let appKey = "mydashplus";
+        const LOCAL_KEY = "MYDASHPLUS_LOCAL";
+        const LEGACY_DB = "VPLAT_V3_ITEMS", LEGACY_LG = "VPLAT_V3_LOGS", LEGACY_OF = "VPLAT_V3_FOLDERS";
 
         async function init() {
             try {
-                await OBR.onReady(async () => {
-                    state.uid = await OBR.player.getId();
-                    state.uname = await OBR.player.getName();
-                    OBR.scene.onMetadataChange(m => { 
-                        state.items=m[DB]||{}; 
-                        state.log=m[LG]||[]; 
-                        state.openFolders=m[OF]||{}; 
-                        if(!state.isModified) render(); 
+                if (window.OBR) {
+                    await OBR.onReady(async () => {
+                        appKey = await OBR.app.getId();
+                        state.uid = await OBR.player.getId();
+                        state.uname = await OBR.player.getName();
+                        OBR.scene.onMetadataChange(m => { 
+                            const data = m[appKey] || {};
+                            state.items = data.items || m[LEGACY_DB] || {}; 
+                            state.log = data.log || m[LEGACY_LG] || []; 
+                            state.openFolders = data.openFolders || m[LEGACY_OF] || {}; 
+                            if(!state.isModified) render(); 
+                        });
+                        const m = await OBR.scene.getMetadata();
+                        const data = m[appKey] || {};
+                        state.items = data.items || m[LEGACY_DB] || {};
+                        state.log = data.log || m[LEGACY_LG] || [];
+                        state.openFolders = data.openFolders || m[LEGACY_OF] || {};
+                        render();
+                        if (!m[appKey] && (m[LEGACY_DB] || m[LEGACY_LG] || m[LEGACY_OF])) {
+                            await save();
+                        }
                     });
-                    const m = await OBR.scene.getMetadata();
-                    state.items=m[DB]||{}; state.log=m[LG]||[]; state.openFolders=m[OF]||{}; render();
-                });
+                } else {
+                    loadLocal();
+                    window.addEventListener('storage', (event) => {
+                        if (event.key === LOCAL_KEY) loadLocal();
+                    });
+                }
             } catch(e) { render(); }
         }
 
-        async function save() { if(window.OBR) await OBR.scene.setMetadata({ [DB]: state.items, [LG]: state.log, [OF]: state.openFolders }); render(); }
+        async function save() { 
+            if(window.OBR) {
+                await OBR.scene.setMetadata({ 
+                    [appKey]: { items: state.items, log: state.log, openFolders: state.openFolders }
+                }); 
+            } else {
+                localStorage.setItem(LOCAL_KEY, JSON.stringify({
+                    items: state.items,
+                    log: state.log,
+                    openFolders: state.openFolders
+                }));
+            }
+            render(); 
+        }
+
+        function canEdit(it) { return !it.owner || it.owner === state.uid; }
 
         function showSaveBtn() { state.isModified = true; document.getElementById('save-btn').style.display = 'flex'; }
         
         async function manualSave() {
             if(!state.id) return;
+            const it = state.items[state.id];
+            if(!canEdit(it)) { alert("No puedes editar: este dash est√° en uso por otro jugador."); return; }
             state.items[state.id].content = document.getElementById('editor').value;
             state.isModified = false;
             document.getElementById('save-btn').style.display = 'none';
             await save();
         }
 
         function newItem(type) {
             const n = document.getElementById('newName').value || "Nuevo";
             const id = "id" + Date.now();
-            state.items[id] = { id, type, name: n, content: 'FUE=20\n[+] Ataque 1d20+FUE', parent: null, owner: null };
+            state.items[id] = { id, type, name: n, content: 'FUE=20\n[+] Ataque 1d20+FUE', parent: null, owner: null, ownerName: null };
             document.getElementById('newName').value = ""; 
             save();
         }
 
         function render() {
             const cont = document.getElementById('items-container'); cont.innerHTML = "";
             const vals = Object.values(state.items);
             
             vals.filter(f => f.type === 'folder').forEach(f => {
                 const isOpen = state.openFolders[f.id];
                 const fd = document.createElement('div');
                 fd.className = "card folder"; 
                 fd.innerHTML = `<span>${isOpen ? 'üìÇ' : 'üìÅ'} ${f.name}</span><span onclick="event.stopPropagation(); deleteFolder('${f.id}')" style="color:var(--fail); font-size:18px;">üóëÔ∏è</span>`;
                 fd.onclick = () => { state.openFolders[f.id] = !isOpen; save(); };
                 fd.ondragover = e => e.preventDefault();
                 fd.ondrop = (e) => { e.stopPropagation(); if(state.dragId) { state.items[state.dragId].parent = f.id; save(); } };
                 cont.appendChild(fd);
                 if(isOpen) vals.filter(d => d.parent === f.id).forEach(d => {
                     const child = createCard(d); child.style.marginLeft = "20px"; child.style.width = "calc(100% - 20px)"; cont.appendChild(child);
                 });
             });
 
             vals.filter(it => it.type === 'dash' && !it.parent).forEach(d => {
                 const card = createCard(d);
                 card.ondrop = (e) => { e.stopPropagation(); if(state.dragId) { state.items[state.dragId].parent = null; save(); } };
                 cont.appendChild(card);
             });
             
             document.getElementById('log-content').innerHTML = state.log.map(l => 
-                `<div><b>[${l.file || 'DASH'}]:</b> ${l.f} ‚ûî <span style="color:var(--p); font-weight:bold;">${l.r}</span> <small>(${l.details})</small></div>`
+                `<div><b>[${l.file || 'DASH'}]</b> ${l.f} ‚ûî <span style="color:var(--p); font-weight:bold;">${l.r}</span> <small>(${l.details})</small> <span style="color:#666;">‚Ä¢ ${l.by || 'Jugador'}</span></div>`
             ).join('');
             if(state.id) syncView();
         }
 
         function createCard(it) {
             const d = document.createElement('div'); d.className = "card dash"; d.draggable = true;
             d.innerHTML = `<span>üìÑ ${it.name}</span> ${it.owner ? '<span style="color:var(--p)">üë§</span>' : ''}`;
             d.onclick = () => { state.id = it.id; openDetails(); };
             d.ondragstart = () => state.dragId = it.id;
             return d;
         }
 
         function openDetails() { document.getElementById('view-list').style.display='none'; document.getElementById('view-details').style.display='flex'; switchTab(false); }
         function goBack() { 
             if(state.isModified && !confirm("Cambios sin guardar. ¬øSalir?")) return;
             state.id = null; state.isModified = false;
             document.getElementById('view-list').style.display='flex'; 
             document.getElementById('view-details').style.display='none'; 
             document.getElementById('save-btn').style.display = 'none';
         }
 
         function syncView() {
             const it = state.items[state.id]; if(!it) return;
             document.getElementById('det-title').innerText = it.name.toUpperCase();
             const obtn = document.getElementById('own-btn');
+            const can = canEdit(it);
             if(it.owner === state.uid) { obtn.innerText = "LIBERAR"; obtn.className = "btn-dice btn-owner-true"; }
-            else { obtn.innerText = it.owner ? "OCUPADO" : "OWNEAR"; obtn.className = "btn-dice " + (it.owner ? "" : "btn-owner-false"); }
+            else { obtn.innerText = it.owner ? `OCUPADO` : "OWNEAR"; obtn.className = "btn-dice " + (it.owner ? "" : "btn-owner-false"); }
             document.getElementById('editor-ui').style.display = state.edit ? 'flex' : 'none';
             document.getElementById('preview').style.display = state.edit ? 'none' : 'block';
             if(state.edit) { if(!state.isModified) document.getElementById('editor').value = it.content; } 
             else renderPreview(it.content);
         }
 
+        function loadLocal() {
+            const raw = localStorage.getItem(LOCAL_KEY);
+            const data = raw ? JSON.parse(raw) : {};
+            state.items = data.items || {};
+            state.log = data.log || [];
+            state.openFolders = data.openFolders || {};
+            render();
+        }
+
         // --- L√ìGICA DE DADOS Y VARIABLES PLATINUM ---
         function calculateMemory(txt) {
             const memory = {};
             const lines = txt.split('\n');
             lines.forEach(line => {
                 const base = line.match(/([A-Z0-9_]+)\s*=\s*([\+\-]?\d+)/i);
                 if(base) memory[base[1].toUpperCase()] = parseInt(base[2]);
             });
             return memory;
         }
 
         function renderPreview(txt) {
             const memory = calculateMemory(txt);
             const processedLines = txt.split('\n').map(line => {
                 if (line.trim().startsWith('[+]')) {
                     const content = line.replace('[+]', '').trim();
                     return `<div class="check-btn" onclick="cloneToMyDash(\`${content.replace(/`/g, "\\`")}\`)">${renderElements(content, memory)}</div>`;
                 }
                 return renderElements(line, memory);
             });
             document.getElementById('preview').innerHTML = processedLines.join('<br>');
         }
 
         function renderElements(txt, memory) {
             return txt
@@ -268,63 +313,84 @@
             
             document.getElementById('dice-overlay').style.display = 'flex';
             document.getElementById('d-f').innerText = formulaRaw;
             const container = document.getElementById('dice-container'); container.innerHTML = "";
             const totalVal = document.getElementById('total-val'); totalVal.classList.remove('show');
             
             let currentSum = 0; let logDetails = [];
             for(let res of results) {
                 const die = document.createElement('div'); die.className = "die-num"; die.innerText = "?"; container.appendChild(die);
                 await new Promise(r => {
                     let t = 0;
                     const iv = setInterval(() => {
                         die.innerText = Math.floor(Math.random()*s)+1;
                         if(t++ > 7) {
                             clearInterval(iv); die.innerText = res;
                             if(res === s) die.style.color = "var(--crit)";
                             if(res === 1) die.style.color = "var(--fail)";
                             currentSum += res; logDetails.push(res); r();
                         }
                     }, 50);
                 });
             }
             let final; try { final = Math.floor(eval(logic.replace(diceMatch[0], currentSum))); } catch(e) { final = currentSum; }
             setTimeout(() => { totalVal.innerText = final; totalVal.classList.add('show'); }, 200);
             
-            state.log.unshift({ file: it.name, f: formulaRaw, r: final, details: logDetails.join('+') });
+            state.log.unshift({ file: it.name, f: formulaRaw, r: final, details: logDetails.join('+'), by: state.uname });
             if(state.log.length > 15) state.log.pop(); 
             save();
         }
 
         // --- IMPORT / EXPORT ---
         function exportJSON() {
             const data = JSON.stringify({ items: state.items, folders: state.openFolders, log: state.log });
             const blob = new Blob([data], {type: 'application/json'});
             const url = URL.createObjectURL(blob);
             const a = document.createElement('a'); a.href = url; a.download = `platinum_backup.json`; a.click();
         }
 
         function importJSON(input) {
             const reader = new FileReader();
             reader.onload = e => {
                 const data = JSON.parse(e.target.result);
                 state.items = data.items; state.openFolders = data.folders; state.log = data.log || [];
                 save(); alert("Importado con √©xito");
             };
             reader.readAsText(input.files[0]);
         }
 
-        function toggleOwnership() { const it = state.items[state.id]; it.owner = it.owner ? null : state.uid; save(); }
+        function toggleOwnership() { 
+            const it = state.items[state.id];
+            if(it.owner && it.owner !== state.uid) { alert(`Este dash est√° en uso por ${it.ownerName || 'otro jugador'}.`); return; }
+            if(it.owner === state.uid) { it.owner = null; it.ownerName = null; }
+            else { it.owner = state.uid; it.ownerName = state.uname; }
+            save(); 
+        }
         function openNote(t, c) { document.getElementById('note-title').innerText = t; document.getElementById('note-body').innerText = decodeURIComponent(c).replace(/  /g, '\n'); document.getElementById('note-overlay').style.display='flex'; }
-        function switchTab(isEdit) { state.edit = isEdit; syncView(); }
+        function switchTab(isEdit) { 
+            if(isEdit) {
+                const it = state.items[state.id];
+                if(!canEdit(it)) { alert(`Este dash est√° en uso por ${it.ownerName || 'otro jugador'}.`); return; }
+            }
+            state.edit = isEdit; 
+            syncView(); 
+        }
         function wrap(a, b) { const e = document.getElementById('editor'); const s = e.selectionStart, end = e.selectionEnd; e.value = e.value.substring(0, s) + a + e.value.substring(s, end) + b + e.value.substring(end); showSaveBtn(); }
         function ins(a, b) { document.getElementById('editor').value += a+b; showSaveBtn(); }
         function askNote() { const t=prompt("T:"); const c=prompt("C:"); if(t&&c) ins(`\n[note=${t}]${c}[/note]`, ""); }
         function askGlow() { const c=prompt("Color:"); if(c) wrap(`<g=${c}>`, `</g>`); }
-        function deleteItem() { if(confirm("¬øBorrar?")) { delete state.items[state.id]; save(); goBack(); } }
+        function deleteItem() { 
+            const it = state.items[state.id];
+            if(!canEdit(it)) { alert("No puedes eliminar: este dash est√° en uso por otro jugador."); return; }
+            if(confirm("¬øBorrar?")) { delete state.items[state.id]; save(); goBack(); } 
+        }
         function deleteFolder(fid) { if(confirm("¬øBorrar carpeta?")) { Object.values(state.items).forEach(it => { if(it.parent === fid) it.parent = null; }); delete state.items[fid]; save(); } }
-        function cloneToMyDash(t) { const my = Object.values(state.items).find(i => i.owner === state.uid); if(my) { my.content += "\n"+t; save(); alert("Clonado"); } }
+        function cloneToMyDash(t) { 
+            const my = Object.values(state.items).find(i => i.owner === state.uid); 
+            if(my) { my.content += "\n"+t; save(); alert("Clonado"); }
+            else { alert("Necesitas ownear un dash para clonar."); }
+        }
 
         init();
     </script>
 </body>
 </html>
 
EOF
)
