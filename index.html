<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <script src="https://unpkg.com/@owlbear-rodeo/sdk/dist/obr.js"></script>
    <style>
        :root { 
            --p: #bb86fc; --bg: #0d0d0f; --c: #1a1a1d; --t: #f0f0f0; 
            --accent: #03dac6; --crit: #00ff88; --fail: #ff4466; --folder: #ff9800;
        }
        
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--t); margin: 0; padding: 10px; user-select: none; }
        
        /* Header */
        .header-main { text-align: center; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .signature { font-size: 16px; font-weight: bold; color: var(--p); text-shadow: 0 0 8px var(--p); }

        /* Controles */
        .input-group { display: flex; gap: 5px; margin-bottom: 15px; }
        input { flex: 1; padding: 10px; background: #1a1a1d; color: white; border: 1px solid #333; border-radius: 8px; outline: none; }
        .tool { background: #2d2d30; color: white; border: none; padding: 7px 12px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: bold; }
        .tool:hover { background: var(--p); color: #000; }

        /* Lista Principal */
        #list-container { display: flex; flex-direction: column; gap: 6px; }
        .item-card { padding: 12px; border-radius: 8px; border: 1px solid #252529; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: #16161a; }
        .dash-card { border-left: 4px solid var(--p); }
        .folder-card { background: #1d170e; border-left: 4px solid var(--folder); color: var(--folder); font-weight: bold; }
        .child { margin-left: 20px; }

        /* Editor y Preview */
        #editor-ui { display: none; }
        textarea { width: 100%; height: 260px; background: #0f0f11; color: #ccc; padding: 15px; border: 1px solid #333; border-radius: 0 0 8px 8px; font-family: monospace; box-sizing: border-box; outline: none; resize: vertical; }
        .toolbar { display: flex; gap: 4px; background: #1e1e1e; padding: 8px; border-radius: 8px 8px 0 0; border: 1px solid #333; }
        
        #preview { padding: 15px; display: none; background: rgba(255,255,255,0.03); border: 1px solid #333; border-radius: 0 0 8px 8px; line-height: 1.6; }

        /* Elementos Especiales */
        .cb-box { display: flex; align-items: center; background: rgba(3,218,198,0.06); padding: 10px; border-radius: 8px; margin: 8px 0; border-left: 4px solid var(--accent); }
        .cb-plus { width: 18px; height: 18px; margin-right: 12px; accent-color: var(--accent); cursor: pointer; }
        .note-btn { background: rgba(187,134,252,0.1); color: var(--p); border: 1px solid var(--p); padding: 5px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; margin: 4px 2px; }

        /* Historial */
        .log-area { background: #000; border: 1px solid #222; border-radius: 8px; margin-top: 15px; }
        #log-content { height: 100px; overflow-y: auto; padding: 8px; font-size: 11px; color: #aaa; }

        /* Modales */
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal { background: #1a1a1d; border: 1px solid #333; padding: 20px; border-radius: 12px; width: 85%; max-width: 400px; text-align: center; }
    </style>
</head>
<body>

    <div id="view-list">
        <div class="header-main">
            <div class="signature">DASHES v1.3.9</div>
            <div style="font-size:9px; color:var(--p)">SISTEMA RESTAURADO</div>
        </div>
        <div class="input-group">
            <input type="text" id="itemName" placeholder="Nuevo Dash o Carpeta...">
            <button onclick="newItem('dash')" class="tool" style="background:var(--p); color:#000;">+DASH</button>
            <button onclick="newItem('folder')" class="tool" style="background:var(--folder); color:#000;">+CARPETA</button>
        </div>
        <div id="list-container"></div>
        <div class="log-area">
            <div style="font-size:9px; padding:5px; border-bottom:1px solid #222;">HISTORIAL DE DADOS</div>
            <div id="log-content"></div>
        </div>
    </div>

    <div id="view-details" style="display:none;">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom:10px;">
            <button onclick="goBack()" class="tool">‚¨Ö ATR√ÅS</button>
            <div id="detail-title" class="signature"></div>
            <button onclick="openOwner()" class="tool">üë§</button>
        </div>
        <button onclick="toggleView()" id="btn-mode" style="width:100%; padding:12px; background:var(--p); color:#000; font-weight:bold; border:none; border-radius:8px; cursor:pointer; margin-bottom:10px;">MODO JUEGO</button>
        
        <div id="editor-ui">
            <div class="toolbar">
                <button class="tool" onclick="ins('[cb] TEXTO','')">üîò Casilla+</button>
                <button class="tool" onclick="ins('[note=T√çTULO]CONTENIDO[/note]','')">üìù Nota+</button>
                <button class="tool" onclick="deleteItem()" style="background:var(--fail)">üóëÔ∏è BORRAR</button>
            </div>
            <textarea id="editor" oninput="updateContent()"></textarea>
        </div>
        <div id="preview"></div>
    </div>

    <div id="global-overlay" class="overlay" onclick="closeModal()"><div id="modal-content" class="modal" onclick="event.stopPropagation()"></div></div>

    <script>
        let state = { items: {}, id: null, editing: false, uid: 'local', uname: 'User', dragId: null };
        const KEY = "DASH_STABLE_139";
        const LOG_KEY = "LOG_STABLE_139";

        async function init() {
            try {
                await OBR.onReady(async () => {
                    state.uid = await OBR.player.getId();
                    state.uname = await OBR.player.getName();
                    OBR.scene.onMetadataChange(m => {
                        state.items = m[KEY] || {};
                        drawList();
                        drawLog(m[LOG_KEY] || []);
                        if(state.id) syncView();
                    });
                });
            } catch(e) { /* Web Mode */ }
        }

        async function save() { await OBR.scene.setMetadata({ [KEY]: state.items }); }

        function newItem(type) {
            const name = document.getElementById('itemName').value || "Nuevo";
            const id = "i" + Date.now();
            state.items[id] = { id, type, name, content: "# " + name, owner: null, parent: null };
            document.getElementById('itemName').value = '';
            save();
        }

        function drawList() {
            const container = document.getElementById('list-container');
            container.innerHTML = '';
            const all = Object.values(state.items);

            // Renderizar Carpetas y sus hijos
            all.filter(i => i.type === 'folder').forEach(f => {
                container.appendChild(makeCard(f));
                all.filter(i => i.parent === f.id).forEach(c => container.appendChild(makeCard(c, true)));
            });

            // Renderizar sueltos
            all.filter(i => i.type === 'dash' && !i.parent).forEach(d => container.appendChild(makeCard(d)));
        }

        function makeCard(item, isChild) {
            const div = document.createElement('div');
            div.className = `item-card ${item.type === 'folder' ? 'folder-card' : 'dash-card'} ${isChild ? 'child' : ''}`;
            div.draggable = true;
            div.innerHTML = `<span>${item.type==='folder'?'üìÅ':'üìÑ'} ${item.name}</span> ${item.owner ? 'üë§' : ''}`;
            div.onclick = () => { state.id = item.id; openDetails(); };
            div.ondragstart = () => state.dragId = item.id;
            div.ondragover = e => e.preventDefault();
            div.ondrop = e => { e.preventDefault(); if(item.type==='folder') move(state.dragId, item.id); };
            return div;
        }

        async function move(id, parentId) { 
            if(id === parentId) return;
            state.items[id].parent = parentId; 
            await save(); 
        }

        function openDetails() {
            document.getElementById('view-list').style.display = 'none';
            document.getElementById('view-details').style.display = 'block';
            state.editing = false;
            syncView();
        }

        function syncView() {
            const item = state.items[state.id];
            if(!item) return goBack();
            document.getElementById('detail-title').innerText = item.name;
            document.getElementById('editor-ui').style.display = state.editing ? 'block' : 'none';
            document.getElementById('preview').style.display = state.editing ? 'none' : 'block';
            document.getElementById('btn-mode').innerText = state.editing ? "üíæ GUARDAR" : "‚úçÔ∏è EDITAR";
            document.getElementById('editor').value = item.content;
            if(!state.editing) render(item.content);
        }

        function render(txt) {
            let h = txt
                .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
                .replace(/\[note=(.*?)\](.*?)\[\/note\]/gs, (m, t, c) => {
                    return `<button class="note-btn" onclick="showNote('${t}', '${c.replace(/\n/g, '<br>').replace(/'/g, "\\'")}')">üìå ${t}</button>`;
                })
                .replace(/\[cb\]\s*(.*?)(?:\n|$)/gi, (m, c) => {
                    return `<div class="cb-box"><input type="checkbox" class="cb-plus" onclick="transfer('${c.replace(/'/g, "\\'")}', this)"><div>${c}</div></div>`;
                })
                .replace(/(\d*d\d+[\+\-0-9]*)/gi, f => `<span style="color:var(--p);cursor:pointer;font-weight:bold;" onclick="doRoll('${f}')">${f}</span>`);

            document.getElementById('preview').innerHTML = h.replace(/\n/g, '<br>');
        }

        async function transfer(text, cb) {
            if(!cb.checked) return;
            const target = Object.values(state.items).find(i => i.owner === state.uid);
            if(target) {
                target.content += "\n" + text;
                await save();
                cb.disabled = true;
                cb.parentElement.style.opacity = "0.5";
            } else {
                alert("Asignate un Dash con el icono üë§");
                cb.checked = false;
            }
        }

        async function doRoll(f) {
            const r = Math.floor(Math.random()*20)+1; 
            const entry = { u: state.uname, f: f, r: r };
            const m = await OBR.scene.getMetadata();
            const logs = [entry, ...(m[LOG_KEY] || [])].slice(0, 15);
            await OBR.scene.setMetadata({ [LOG_KEY]: logs });
        }

        function drawLog(logs) {
            document.getElementById('log-content').innerHTML = logs.map(l => `<div><b>${l.u}:</b> ${l.f} ‚ûî ${l.r}</div>`).join('');
        }

        function showNote(t, c) {
            document.getElementById('modal-content').innerHTML = `<h3>${t}</h3><div style="text-align:left;">${c}</div><button onclick="closeModal()" class="tool" style="width:100%;margin-top:15px;">CERRAR</button>`;
            document.getElementById('global-overlay').style.display = 'flex';
        }

        function toggleView() { state.editing = !state.editing; syncView(); }
        function updateContent() { state.items[state.id].content = document.getElementById('editor').value; save(); }
        function goBack() { state.id = null; document.getElementById('view-list').style.display = 'block'; document.getElementById('view-details').style.display = 'none'; }
        function closeModal() { document.getElementById('global-overlay').style.display = 'none'; }
        
        async function openOwner() {
            const p = await OBR.party.getPlayers();
            let h = `<h3>Due√±o del Dash</h3>`;
            p.forEach(player => h += `<button onclick="setOwner('${player.id}')" style="width:100%; padding:10px; margin:4px 0; background:var(--p); border:none; border-radius:8px; font-weight:bold;">${player.name}</button>`);
            document.getElementById('modal-content').innerHTML = h;
            document.getElementById('global-overlay').style.display = 'flex';
        }

        function setOwner(uid) { state.items[state.id].owner = uid; save(); closeModal(); }
        function ins(a, b) { const e = document.getElementById('editor'); const s = e.selectionStart, end = e.selectionEnd; e.value = e.value.substring(0, s) + a + b + e.value.substring(end); updateContent(); }
        async function deleteItem() { if(confirm("¬øEliminar?")) { delete state.items[state.id]; await save(); goBack(); } }

        init();
    </script>
</body>
</html>
