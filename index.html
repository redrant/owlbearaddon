<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/@owlbear-rodeo/sdk/dist/obr.js"></script>
    <style>
        :root { 
            --p: #bb86fc; --bg: #0d0d0f; --surf: #1a1a1d; --t: #f0f0f0; 
            --accent: #03dac6; --crit: #00ff88; --fail: #ff4466; --folder: #ff9800;
        }
        
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--t); margin: 0; padding: 10px; user-select: none; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* HEADER & SIGNATURE */
        .header-main { text-align: center; border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 10px; }
        .version { font-size: 9px; color: var(--p); font-weight: bold; letter-spacing: 2px; }
        .signature { font-size: 16px; font-weight: bold; color: var(--p); text-shadow: 0 0 10px var(--p); }

        /* CONTROLS */
        .input-group { display: flex; gap: 5px; margin-bottom: 10px; }
        input[type="text"] { flex: 1; padding: 10px; background: #222; color: white; border: 1px solid #444; border-radius: 8px; outline: none; }
        .btn { border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 11px; color: #000; transition: 0.2s; }
        .btn-p { background: var(--p); } .btn-f { background: var(--folder); }
        .btn-ghost { background: transparent; color: var(--t); border: 1px solid #444; }

        /* LIST & FOLDERS */
        #list-container { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; padding-right: 5px; }
        .item-card { padding: 10px; border-radius: 8px; border: 1px solid #252529; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: #16161a; }
        .folder-card { border-left: 4px solid var(--folder); color: var(--folder); font-weight: bold; }
        .dash-card { border-left: 4px solid var(--p); }
        .child { margin-left: 20px; display: none; } /* Colapsado por defecto */
        .is-open { display: flex !important; }

        /* EDITOR & PREVIEW */
        #view-details { display: none; flex-direction: column; height: 100%; position: relative; }
        .editor-wrap { flex: 1; display: flex; flex-direction: column; }
        textarea { flex: 1; background: #080808; color: #bbb; padding: 15px; border: 1px solid #333; border-radius: 0 0 8px 8px; font-family: 'Consolas', monospace; resize: none; outline: none; line-height: 1.4; }
        .toolbar { display: flex; gap: 4px; background: #1e1e1e; padding: 8px; border-radius: 8px 8px 0 0; border: 1px solid #333; flex-wrap: wrap; }
        
        #preview { flex: 1; padding: 20px; overflow-y: auto; background: #0d0d0f; border: 1px solid #333; border-radius: 8px; line-height: 1.6; display: none; }

        /* VISUAL ELEMENTS */
        .glow { font-weight: bold; }
        .note-btn { background: rgba(187,134,252,0.1); color: var(--p); border: 1px solid var(--p); padding: 3px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; margin: 2px; font-weight: bold; }
        .cb-box { display: flex; align-items: center; background: rgba(3,218,198,0.05); padding: 8px; border-radius: 6px; margin: 5px 0; border-left: 3px solid var(--accent); }
        .cb-check { width: 17px; height: 17px; margin-right: 10px; accent-color: var(--accent); cursor: pointer; }
        .roll-trigger { color: var(--accent); font-weight: bold; cursor: pointer; text-decoration: underline dotted; }

        /* LOG PANEL */
        .log-area { height: 110px; background: #000; border: 1px solid #222; border-radius: 8px; margin-top: 10px; display: flex; flex-direction: column; }
        #log-content { flex: 1; overflow-y: auto; padding: 8px; font-size: 11px; font-family: monospace; }
        .log-row { border-bottom: 1px solid #111; padding: 2px 0; }

        /* MODAL */
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 999; }
        .modal { background: #1a1a1d; border: 1px solid #444; padding: 20px; border-radius: 12px; width: 85%; max-width: 400px; box-shadow: 0 10px 30px #000; }
    </style>
</head>
<body>

    <div id="view-list">
        <div class="header-main">
            <div class="version">V 1.0.0v</div>
            <div class="signature">My Dashesh - By Redrant :v</div>
        </div>
        <div class="input-group">
            <input type="text" id="itemName" placeholder="Nuevo elemento...">
            <button onclick="addItem('dash')" class="btn btn-p">+DASH</button>
            <button onclick="addItem('folder')" class="btn btn-f">+CARPETA</button>
        </div>
        <div id="list-container"></div>
        <div class="log-area">
            <div style="font-size:9px; padding:3px 8px; background:#111; color:#666;">HISTORIAL DE DADOS</div>
            <div id="log-content"></div>
        </div>
    </div>

    <div id="view-details">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom:8px;">
            <button onclick="closeDetails()" class="btn btn-ghost">‚¨Ö VOLVER</button>
            <div id="detail-title" class="signature"></div>
            <button onclick="setOwnerMenu()" class="btn btn-ghost">üë§</button>
        </div>
        
        <button onclick="toggleVisual()" id="mode-btn" style="width:100%; padding:10px; background:var(--p); color:#000; font-weight:bold; border:none; border-radius:8px; cursor:pointer; margin-bottom:10px;">VISUALIZAR</button>

        <div id="editor-ui" class="editor-wrap">
            <div class="toolbar">
                <button class="btn btn-ghost" onclick="ins('[cb] ','')">üîò CasillaPro+</button>
                <button class="btn btn-ghost" onclick="ins('[note=TITULO]','[/note]')">üìù NotaPro+</button>
                <button class="btn btn-ghost" onclick="wrap('<g=gold>','</g>')">‚ú® Glow</button>
                <button class="btn btn-ghost" onclick="wrap('**','**')"><b>B</b></button>
                <button class="btn btn-ghost" onclick="wrap('*','*')"><i>I</i></button>
                <button class="btn btn-p" onclick="deleteItem()" style="background:var(--fail);margin-left:auto;">üóëÔ∏è</button>
            </div>
            <textarea id="editor" oninput="updateLocal()"></textarea>
        </div>
        <div id="preview"></div>
    </div>

    <div id="global-modal" class="overlay" onclick="this.style.display='none'">
        <div class="modal" onclick="event.stopPropagation()" id="modal-body"></div>
    </div>

    <script>
        const KEY = "MYDASHES_100V_PRO";
        const LOG = "MYDASHES_LOG_PRO";
        let state = { items: {}, id: null, editMode: true, uid: 'local', uname: 'Player', dragId: null, openFolders: {} };

        async function init() {
            try {
                await OBR.onReady(async () => {
                    state.uid = await OBR.player.getId();
                    state.uname = await OBR.player.getName();
                    OBR.scene.onMetadataChange(m => {
                        state.items = m[KEY] || {};
                        drawList();
                        drawLog(m[LOG] || []);
                        if(state.id) syncDetails();
                    });
                });
            } catch(e) { console.warn("Local Mode"); }
        }

        async function save() { await OBR.scene.setMetadata({ [KEY]: state.items }); }

        function addItem(type) {
            const name = document.getElementById('itemName').value || "Nuevo";
            const id = "id_" + Date.now();
            state.items[id] = { id, type, name, content: "# " + name + "\nFUE=10\n1d20+FUE", owner: null, parent: null };
            document.getElementById('itemName').value = '';
            save();
        }

        function drawList() {
            const container = document.getElementById('list-container');
            container.innerHTML = '';
            const all = Object.values(state.items);

            // Carpetas
            all.filter(i => i.type === 'folder').forEach(f => {
                const fDiv = document.createElement('div');
                fDiv.className = 'item-card folder-card';
                fDiv.innerHTML = `<span>üìÅ ${f.name.toUpperCase()}</span> <small>${state.openFolders[f.id] ? '‚ñ≤' : '‚ñº'}</small>`;
                fDiv.onclick = () => { state.openFolders[f.id] = !state.openFolders[f.id]; drawList(); };
                fDiv.ondragover = e => e.preventDefault();
                fDiv.ondrop = e => { e.preventDefault(); move(state.dragId, f.id); };
                container.appendChild(fDiv);

                all.filter(c => c.parent === f.id).forEach(dash => {
                    container.appendChild(makeDash(dash, true, state.openFolders[f.id]));
                });
            });

            // Dashes sueltos
            all.filter(i => i.type === 'dash' && !i.parent).forEach(dash => {
                container.appendChild(makeDash(dash, false));
            });
        }

        function makeDash(item, isChild, isVisible) {
            const div = document.createElement('div');
            div.className = `item-card dash-card ${isChild ? 'child' : ''} ${isChild && isVisible ? 'is-open' : ''}`;
            div.draggable = true;
            div.innerHTML = `<span>üìÑ ${item.name}</span> ${item.owner ? 'üë§' : ''}`;
            div.onclick = (e) => { e.stopPropagation(); state.id = item.id; openDetails(); };
            div.ondragstart = () => state.dragId = item.id;
            div.ondragover = e => e.preventDefault();
            div.ondrop = e => { e.preventDefault(); move(state.dragId, null); };
            return div;
        }

        async function move(id, pid) { if(id !== pid) { state.items[id].parent = pid; await save(); } }

        function openDetails() {
            document.getElementById('view-list').style.display = 'none';
            document.getElementById('view-details').style.display = 'flex';
            state.editMode = true;
            syncDetails();
        }

        function syncDetails() {
            const item = state.items[state.id];
            if(!item) return closeDetails();
            document.getElementById('detail-title').innerText = item.name;
            document.getElementById('editor-ui').style.display = state.editMode ? 'flex' : 'none';
            document.getElementById('preview').style.display = state.editMode ? 'none' : 'block';
            document.getElementById('mode-btn').innerText = state.editMode ? "VISUALIZAR" : "EDITAR";
            
            if (document.activeElement !== document.getElementById('editor')) {
                document.getElementById('editor').value = item.content;
            }
            if(!state.editMode) renderPreview(item.content);
        }

        function renderPreview(raw) {
            const vars = {};
            // 1. Detectar variables FUE=10
            raw.replace(/(\w+)\s*=\s*([\-\d]+)/g, (m, k, v) => vars[k.toUpperCase()] = parseInt(v));

            let html = raw
                .replace(/  /g, '<br>') // Doble espacio = rengl√≥n
                .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
                .replace(/\*(.*?)\*/g, '<i>$1</i>')
                .replace(/<g=(.*?)>(.*?)<\/g>/g, '<span class="glow" style="text-shadow: 0 0 10px $1; color:white;">$2</span>')
                .replace(/\[note=(.*?)\](.*?)\[\/note\]/gs, (m, t, c) => {
                    const safe = c.replace(/\n/g, '<br>').replace(/'/g, "\\'");
                    return `<button class="note-btn" onclick="showNote('${t}', '${safe}')">${t}</button>`;
                })
                .replace(/\[cb\]\s*(.*?)(?:\n|$)/gi, (m, c) => {
                    return `<div class="cb-box"><input type="checkbox" class="cb-check" onclick="transfer('${c.replace(/'/g, "\\'")}', this)"><span>${c}</span></div>`;
                })
                // Dados con variables avanzadas (+5FUE, 1d20+FUE*2, etc)
                .replace(/([\d]*d\d+[\+\-\*\/\d\w\(\)]*|[\+\-]\d+\w+)/gi, f => {
                    return `<span class="roll-trigger" onclick="doRoll('${f}', ${JSON.stringify(vars)})">${f}</span>`;
                });

            document.getElementById('preview').innerHTML = html.replace(/\n/g, '<br>');
        }

        async function doRoll(formula, vars) {
            let f = formula.toUpperCase();
            // Reemplazar variables
            for (let v in vars) { f = f.replace(new RegExp(v, 'g'), vars[v]); }
            
            // Procesar Dados
            let logs = [];
            f = f.replace(/(\d*)D(\d+)/g, (m, n, d) => {
                let count = parseInt(n) || 1;
                let sides = parseInt(d);
                let sum = 0;
                for(let i=0; i<count; i++){
                    let r = Math.floor(Math.random()*sides)+1;
                    sum += r; logs.push(r);
                }
                return `(${sum})`;
            });

            let result;
            try { result = eval(f); } catch(e) { result = "Error"; }

            const entry = { u: state.uname, f: formula, r: result, d: logs.join(', ') };
            const currentLogs = (await OBR.scene.getMetadata())[LOG] || [];
            await OBR.scene.setMetadata({ [LOG]: [entry, ...currentLogs].slice(0, 20) });
        }

        async function transfer(txt, cb) {
            if(!cb.checked) return;
            const target = Object.values(state.items).find(i => i.owner === state.uid);
            if(target) {
                target.content += "\n" + txt;
                await save();
                cb.disabled = true;
                cb.parentElement.style.opacity = "0.5";
            } else {
                alert("Primero as√≠gnate un Dash con el icono üë§");
                cb.checked = false;
            }
        }

        function drawLog(logs) {
            document.getElementById('log-content').innerHTML = logs.map(l => `
                <div class="log-row"><b>${l.u}:</b> ${l.f} ‚ûî <b>${l.r}</b> <small style="color:#555">(${l.d})</small></div>
            `).join('');
        }

        function showNote(t, c) {
            const body = document.getElementById('modal-body');
            body.innerHTML = `<h3 style="color:var(--p);margin-top:0;">${t}</h3><div style="line-height:1.5">${c}</div>`;
            document.getElementById('global-modal').style.display = 'flex';
        }

        async function setOwnerMenu() {
            const players = await OBR.party.getPlayers();
            const body = document.getElementById('modal-body');
            let h = `<h3 style="color:var(--p)">Asignar Due√±o</h3>`;
            players.forEach(p => {
                h += `<button onclick="setOwner('${p.id}')" style="width:100%; padding:10px; margin:4px 0; background:var(--p); border:none; border-radius:8px; font-weight:bold; cursor:pointer;">${p.name}</button>`;
            });
            body.innerHTML = h;
            document.getElementById('global-modal').style.display = 'flex';
        }

        function setOwner(uid) { state.items[state.id].owner = uid; save(); document.getElementById('global-modal').style.display = 'none'; }
        function toggleVisual() { state.editMode = !state.editMode; syncDetails(); }
        function updateLocal() { state.items[state.id].content = document.getElementById('editor').value; save(); }
        function closeDetails() { state.id = null; document.getElementById('view-list').style.display = 'block'; document.getElementById('view-details').style.display = 'none'; }
        function ins(a, b) { const e = document.getElementById('editor'); const s = e.selectionStart, end = e.selectionEnd; e.value = e.value.substring(0, s) + a + b + e.value.substring(end); updateLocal(); }
        function wrap(a, b) { const e = document.getElementById('editor'); const s = e.selectionStart, end = e.selectionEnd; e.value = e.value.substring(0, s) + a + e.value.substring(s, end) + b + e.value.substring(end); updateLocal(); }
        async function deleteItem() { if(confirm("¬øBorrar?")) { delete state.items[state.id]; await save(); closeDetails(); } }

        init();
    </script>
</body>
</html>
