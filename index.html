<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/@owlbear-rodeo/sdk/dist/obr.js"></script>
    <style>
        :root { 
            --p: #bb86fc; --bg: #121212; --surf: #1e1e1e; --t: #e0e0e0; 
            --accent: #03dac6; --crit: #00ff88; --fail: #ff4466; --folder: #ff9800;
        }
        
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--t); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* HEADER */
        .header { background: var(--surf); padding: 10px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        .title { font-weight: bold; color: var(--p); letter-spacing: 1px; font-size: 14px; }
        .version { font-size: 10px; opacity: 0.6; }

        /* LIST VIEW */
        #view-list { flex: 1; display: flex; flex-direction: column; padding: 10px; overflow: hidden; }
        .controls { display: flex; gap: 5px; margin-bottom: 10px; }
        input { background: #2c2c2c; border: 1px solid #444; color: white; padding: 8px; border-radius: 4px; flex: 1; outline: none; }
        input:focus { border-color: var(--p); }
        
        .btn { border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 11px; transition: 0.2s; color: #000; }
        .btn-p { background: var(--p); } .btn-p:hover { background: #d0aeff; }
        .btn-f { background: var(--folder); } .btn-f:hover { background: #ffb74d; }
        .btn-d { background: var(--fail); color: white; }
        .btn-ghost { background: transparent; color: var(--t); border: 1px solid #444; }
        .btn-ghost:hover { background: rgba(255,255,255,0.1); }

        .list-area { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; }
        
        /* CARDS */
        .card { padding: 10px; background: #252525; border-radius: 6px; border: 1px solid #333; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .card:hover { background: #303030; border-color: #555; }
        .is-folder { border-left: 4px solid var(--folder); }
        .is-dash { border-left: 4px solid var(--p); }
        .is-child { margin-left: 20px; border-left: 2px solid var(--p); }
        .owner-tag { font-size: 10px; background: #333; padding: 2px 6px; border-radius: 10px; color: var(--accent); border: 1px solid var(--accent); }

        /* LOG AREA */
        .log-panel { height: 120px; background: #000; border-top: 1px solid #333; padding: 8px; overflow-y: auto; font-family: monospace; font-size: 11px; }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #222; padding-bottom: 2px; }
        .dice-detail { color: #888; font-size: 10px; }
        .res-crit { color: var(--crit); } .res-fail { color: var(--fail); } .res-high { color: var(--accent); }

        /* DETAILS VIEW */
        #view-details { display: none; flex-direction: column; height: 100%; }
        .editor-container { flex: 1; display: flex; flex-direction: column; position: relative; }
        textarea { flex: 1; background: #151515; color: #ddd; border: none; padding: 15px; resize: none; outline: none; font-family: 'Consolas', monospace; line-height: 1.5; font-size: 14px; }
        
        #preview-area { flex: 1; padding: 15px; overflow-y: auto; line-height: 1.6; display: none; background: #151515; }
        
        /* Elements in Preview */
        .cb-row { display: flex; align-items: flex-start; background: rgba(3,218,198,0.05); border: 1px solid rgba(3,218,198,0.2); padding: 8px; border-radius: 6px; margin: 5px 0; }
        .cb-check { margin-top: 3px; margin-right: 10px; accent-color: var(--accent); cursor: pointer; width: 16px; height: 16px; }
        .note-tag { display: inline-block; background: rgba(187,134,252,0.15); border: 1px solid var(--p); color: var(--p); padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; cursor: pointer; margin: 0 4px; }
        .note-tag:hover { background: var(--p); color: #000; }
        .rollable { color: var(--accent); font-weight: bold; cursor: pointer; text-decoration: underline; text-decoration-style: dotted; }
        .rollable:hover { background: rgba(3,218,198,0.1); }

        /* MODAL */
        .modal-bg { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); z-index: 1000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal { background: #222; width: 85%; max-width: 400px; border-radius: 12px; border: 1px solid #444; overflow: hidden; box-shadow: 0 10px 25px black; }
        .modal-head { background: #2a2a2a; padding: 12px; font-weight: bold; border-bottom: 1px solid #333; color: var(--p); }
        .modal-body { padding: 20px; color: #ccc; max-height: 300px; overflow-y: auto; white-space: pre-wrap; }
        .modal-foot { padding: 10px; display: flex; justify-content: flex-end; }

        /* Utilities */
        .hidden { display: none !important; }
        .mode-toggle { position: absolute; bottom: 20px; right: 20px; z-index: 100; box-shadow: 0 4px 10px black; }
    </style>
</head>
<body>

    <div id="view-list">
        <div class="header">
            <div class="title">MY DASHES <span class="version">v1.0.0</span></div>
            <div id="status-ind" style="width:8px; height:8px; border-radius:50%; background:red;"></div>
        </div>
        <div class="controls">
            <input type="text" id="input-name" placeholder="Nombre...">
            <button class="btn btn-p" onclick="add('dash')">+DASH</button>
            <button class="btn btn-f" onclick="add('folder')">+CARPETA</button>
        </div>
        <div id="list-container" class="list-area"></div>
        <div class="log-panel" id="log-container"></div>
    </div>

    <div id="view-details">
        <div class="header">
            <button class="btn btn-ghost" onclick="goBack()">‚¨Ö Atr√°s</button>
            <span id="dash-title" class="title">TITULO</span>
            <button class="btn btn-ghost" onclick="openOwnerModal()">üë§ Due√±o</button>
        </div>
        
        <div class="editor-container">
            <textarea id="editor" oninput="localUpdate()" spellcheck="false"></textarea>
            <div id="preview-area"></div>
            <button id="btn-mode" class="btn btn-p mode-toggle" onclick="toggleMode()">JUGAR ‚ñ∂</button>
        </div>
        
        <div style="padding:5px; background:#111; display:flex; gap:5px; justify-content:center; border-top:1px solid #333;" id="toolbar">
            <button class="btn btn-ghost" onclick="insertTag('[cb] ', '')">‚òë Casilla</button>
            <button class="btn btn-ghost" onclick="insertTag('[note=Titulo]', '[/note]')">üìù Nota</button>
            <button class="btn btn-ghost" onclick="insertTag('**', '**')">B</button>
            <button class="btn btn-d" onclick="deleteCurrent()">üóë</button>
        </div>
    </div>

    <div id="modal-overlay" class="modal-bg" onclick="closeModal()">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-head" id="modal-title">Info</div>
            <div class="modal-body" id="modal-content">...</div>
            <div class="modal-foot">
                <button class="btn btn-ghost" onclick="closeModal()">Cerrar</button>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURACI√ìN 1.0.0v
        const APP_ID = "com.mydashes.v100";
        let state = { items: {}, log: [] };
        let app = { id: null, editing: true, user: "Local", uid: "local", role: "PLAYER", dragId: null };

        // 1. INICIALIZACI√ìN
        async function init() {
            try {
                if (window.OBR) {
                    await OBR.onReady(async () => {
                        app.user = await OBR.player.getName();
                        app.uid = await OBR.player.getId();
                        app.role = await OBR.player.getRole();
                        document.getElementById('status-ind').style.background = "var(--crit)"; // Online
                        
                        // Sincronizaci√≥n Real
                        OBR.scene.onMetadataChange(refreshData);
                        refreshData(await OBR.scene.getMetadata());
                    });
                } else {
                    throw new Error("Web Mode");
                }
            } catch (e) {
                console.log("Modo Web Local");
                document.getElementById('status-ind').style.background = "var(--folder)"; // Local
                const localData = localStorage.getItem(APP_ID);
                if (localData) refreshData({ [APP_ID]: JSON.parse(localData) });
            }
        }

        // 2. CORE DE DATOS
        function refreshData(metadata) {
            // Recuperar datos o iniciar vac√≠os
            const data = metadata[APP_ID] || { items: {}, log: [] };
            state = data;
            
            // Renderizar Log (siempre visible)
            renderLog();

            // Si estamos en la lista, redibujarla. Si estamos en detalle, actualizar contenido si no estamos escribiendo nosotros
            if (!app.id) {
                renderList();
            } else {
                const item = state.items[app.id];
                if (!item) { goBack(); return; } // Si lo borraron
                
                // Actualizar visualizaci√≥n en tiempo real si estoy en modo juego
                if (!app.editing) {
                    renderPreview(item.content);
                } else {
                    // Si edito, solo actualizo si el foco no es m√≠o para no borrar lo que escribo
                    if (document.activeElement !== document.getElementById('editor')) {
                        document.getElementById('editor').value = item.content;
                    }
                }
            }
        }

        async function saveData() {
            try {
                if (window.OBR && OBR.scene) {
                    await OBR.scene.setMetadata({ [APP_ID]: state });
                } else {
                    localStorage.setItem(APP_ID, JSON.stringify(state));
                    refreshData({ [APP_ID]: state });
                }
            } catch(e) { console.error(e); }
        }

        // 3. LOGICA DE LISTA Y CARPETAS (DRAG & DROP)
        function add(type) {
            const name = document.getElementById('input-name').value || (type === 'folder' ? "Nueva Carpeta" : "Nuevo Dash");
            const id = Date.now().toString(36);
            state.items[id] = { 
                id, type, name, 
                content: type==='dash' ? `# ${name}\n\n[cb] Item de ejemplo\nFUE=10\n1d20+FUE` : null,
                parent: null,
                owner: null
            };
            document.getElementById('input-name').value = "";
            saveData();
        }

        function renderList() {
            const c = document.getElementById('list-container');
            c.innerHTML = "";
            const list = Object.values(state.items);

            // 1. Carpetas y sus hijos
            list.filter(i => i.type === 'folder').forEach(folder => {
                c.appendChild(createCard(folder));
                list.filter(child => child.parent === folder.id).forEach(child => {
                    c.appendChild(createCard(child, true));
                });
            });

            // 2. Hu√©rfanos
            list.filter(i => i.type === 'dash' && !i.parent).forEach(dash => {
                c.appendChild(createCard(dash));
            });
        }

        function createCard(item, isChild = false) {
            const el = document.createElement('div');
            el.className = `card ${item.type === 'folder' ? 'is-folder' : 'is-dash'} ${isChild ? 'is-child' : ''}`;
            
            let html = `<span>${item.type === 'folder' ? 'üìÅ' : 'üìÑ'} ${item.name}</span>`;
            if (item.owner) html += `<span class="owner-tag">üë§ Asignado</span>`;
            el.innerHTML = html;

            el.draggable = true;
            el.ondragstart = (e) => { app.dragId = item.id; e.stopPropagation(); };
            el.ondragover = (e) => { e.preventDefault(); el.style.background = "#444"; };
            el.ondragleave = () => { el.style.background = ""; };
            el.ondrop = (e) => { 
                e.preventDefault(); 
                el.style.background = ""; 
                handleDrop(app.dragId, item.id, item.type); 
            };
            
            el.onclick = () => {
                if (item.type === 'dash') openDash(item.id);
            };

            return el;
        }

        function handleDrop(draggedId, targetId, targetType) {
            if (draggedId === targetId) return;
            // Si suelto sobre carpeta -> entra. Si suelto sobre dash -> se pone al mismo nivel (o root)
            if (targetType === 'folder') {
                state.items[draggedId].parent = targetId;
            } else {
                state.items[draggedId].parent = null; // Sacar de carpeta
            }
            saveData();
        }

        // 4. EDITOR Y PREVISUALIZACI√ìN (PARSER)
        function openDash(id) {
            app.id = id;
            const item = state.items[id];
            document.getElementById('view-list').classList.add('hidden');
            document.getElementById('view-details').style.display = 'flex';
            document.getElementById('dash-title').innerText = item.name.toUpperCase();
            document.getElementById('editor').value = item.content;
            
            // Por defecto abrir en modo ver
            app.editing = false;
            updateModeUI();
        }

        function localUpdate() {
            if (app.id && state.items[app.id]) {
                state.items[app.id].content = document.getElementById('editor').value;
                // Debounce simple para no saturar Owlbear
                if (window.saveTimeout) clearTimeout(window.saveTimeout);
                window.saveTimeout = setTimeout(saveData, 500);
            }
        }

        function toggleMode() {
            app.editing = !app.editing;
            updateModeUI();
        }

        function updateModeUI() {
            const editor = document.getElementById('editor');
            const preview = document.getElementById('preview-area');
            const btn = document.getElementById('btn-mode');
            const tool = document.getElementById('toolbar');

            if (app.editing) {
                editor.classList.remove('hidden');
                preview.classList.add('hidden');
                tool.style.display = 'flex';
                btn.innerText = "JUGAR ‚ñ∂";
                btn.style.background = "var(--p)";
                btn.style.color = "black";
            } else {
                editor.classList.add('hidden');
                preview.classList.remove('hidden');
                tool.style.display = 'none';
                btn.innerText = "‚úé EDITAR";
                btn.style.background = "#333";
                btn.style.color = "white";
                renderPreview(state.items[app.id].content);
            }
        }

        function renderPreview(text) {
            // 1. Parseo de Stats para las f√≥rmulas
            const stats = {};
            text.replace(/([A-Z0-9]+)\s*=\s*([0-9]+)/gi, (m, k, v) => stats[k.toUpperCase()] = parseInt(v));

            let html = text
                // Escape simple
                .replace(/</g, "&lt;").replace(/>/g, "&gt;")
                // Negrita e It√°lica
                .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
                .replace(/\*(.*?)\*/g, '<i>$1</i>')
                // NotasPro+ [note=Titulo]Texto[/note]
                .replace(/\[note=(.*?)\](.*?)\[\/note\]/gs, (match, title, content) => {
                    // Limpiamos comillas para que no rompa el HTML onclick
                    const safeContent = encodeURIComponent(content); 
                    return `<span class="note-tag" onclick="showModal('${title}', '${safeContent}')">üìå ${title}</span>`;
                })
                // CasillasPro+ [cb] Texto
                .replace(/\[cb\]\s*(.*?)(?:\n|$)/gi, (match, txt) => {
                    const safeTxt = txt.trim().replace(/'/g, "&apos;");
                    return `<div class="cb-row">
                        <input type="checkbox" class="cb-check" onclick="transferLoot('${safeTxt}', this)">
                        <span>${txt}</span>
                    </div>`;
                })
                // Dados (ej: 1d20+5, 1d20+FUE)
                .replace(/\b(\d*d\d+[\+\-\*\/A-Z0-9]*)\b/gi, (match) => {
                    return `<span class="rollable" onclick="rollDice('${match}', '${JSON.stringify(stats).replace(/"/g, "&quot;")}')">${match}</span>`;
                });

            document.getElementById('preview-area').innerHTML = html.replace(/\n/g, "<br>");
        }

        // 5. SISTEMAS ACTIVOS: DADOS Y CASILLAS

        async function rollDice(formula, statsJson) {
            const stats = JSON.parse(statsJson);
            let parsedFormula = formula.toUpperCase();
            
            // Reemplazar stats
            Object.keys(stats).forEach(k => {
                parsedFormula = parsedFormula.replace(new RegExp(`\\b${k}\\b`, 'g'), stats[k]);
            });

            // Parsear dados XdY
            const match = parsedFormula.match(/(\d*)D(\d+)/);
            if (!match) return;

            const count = parseInt(match[1]) || 1;
            const sides = parseInt(match[2]);
            let rolls = [];
            let rollSum = 0;

            for(let i=0; i<count; i++) {
                const r = Math.floor(Math.random() * sides) + 1;
                rolls.push(r);
                rollSum += r;
            }

            // Calcular final
            let mathString = parsedFormula.replace(match[0], rollSum).replace(/[^0-9\+\-\*\/\(\)\.]/g, '');
            let finalResult = 0;
            try { finalResult = eval(mathString); } catch(e) { finalResult = rollSum; }

            // LOG
            const logEntry = {
                user: app.user,
                formula: formula, // Mostrar original
                rolls: rolls,
                result: Math.floor(finalResult), // Redondear por si acaso
                ts: Date.now()
            };

            // A√±adir al inicio y recortar historial
            state.log.unshift(logEntry);
            if (state.log.length > 50) state.log.pop();
            await saveData();
        }

        async function transferLoot(text, checkbox) {
            // Buscar Dash propiedad del usuario actual
            const myDashId = Object.keys(state.items).find(key => state.items[key].owner === app.uid);
            
            if (myDashId) {
                state.items[myDashId].content += `\n\n‚úÖ ${text}`; // A√±adir al dash del due√±o
                checkbox.disabled = true; // Desactivar visualmente
                checkbox.parentElement.style.opacity = "0.5";
                await saveData();
                
                // Feedback visual peque√±o
                const toast = document.createElement('div');
                toast.innerText = `Enviado a ${state.items[myDashId].name}`;
                toast.style = "position:fixed; bottom:50px; left:50%; transform:translateX(-50%); background:#333; color:#fff; padding:5px 10px; border-radius:4px; font-size:12px;";
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 2000);
            } else {
                alert("¬°No tienes un Dash asignado! Usa el bot√≥n üë§ Due√±o en tu Dash para reclamarlo.");
                checkbox.checked = false;
            }
        }

        // 6. RENDERIZADO DEL LOG Y UTILIDADES
        function renderLog() {
            const c = document.getElementById('log-container');
            // Solo redibujar si hay cambios para evitar saltos locos (simple check de longitud o primer elemento)
            // Para v1.0 simple: redibujamos todo. Es r√°pido.
            c.innerHTML = state.log.map(l => {
                const rollsStr = l.rolls.map(r => `[${r}]`).join('+');
                return `<div class="log-entry">
                    <span style="color:var(--p); font-weight:bold;">${l.user}:</span> 
                    <span>${l.formula}</span> ‚ûî <span style="font-weight:bold; color:var(--t); font-size:1.1em;">${l.result}</span>
                    <div class="dice-detail">${rollsStr}</div>
                </div>`;
            }).join('');
        }

        function insertTag(start, end) {
            const txt = document.getElementById('editor');
            const s = txt.selectionStart;
            const e = txt.selectionEnd;
            const val = txt.value;
            txt.value = val.substring(0, s) + start + val.substring(s, e) + end + val.substring(e);
            localUpdate();
            txt.focus();
        }

        function goBack() {
            app.id = null;
            document.getElementById('view-details').style.display = 'none';
            document.getElementById('view-list').classList.remove('hidden');
            renderList();
        }

        function deleteCurrent() {
            if(confirm("¬øBorrar este Dash permanentemente?")) {
                delete state.items[app.id];
                saveData();
                goBack();
            }
        }

        // Gesti√≥n de Due√±os
        async function openOwnerModal() {
            let html = `<h3>Asignar Due√±o</h3><p>El due√±o recibe los items de las CasillasPro+.</p>`;
            if (window.OBR) {
                const players = await OBR.party.getPlayers();
                players.forEach(p => {
                    html += `<button class="btn btn-p" style="width:100%; margin-bottom:5px;" onclick="setOwner('${p.id}')">${p.name}</button>`;
                });
            } else {
                html += `<button class="btn btn-p" onclick="setOwner('local')">Usuario Local</button>`;
            }
            showModal("Propietario", encodeURIComponent(html), true);
        }

        function setOwner(uid) {
            state.items[app.id].owner = uid;
            saveData();
            closeModal();
            document.getElementById('dash-title').innerHTML += " (üë§)";
        }

        // Sistema Modal Gen√©rico
        function showModal(title, contentEncoded, isHtml = false) {
            const content = decodeURIComponent(contentEncoded);
            document.getElementById('modal-title').innerText = title;
            const body = document.getElementById('modal-content');
            if(isHtml) body.innerHTML = content;
            else body.innerText = content;
            
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('modal-overlay').style.display = 'none';
        }

        // Arrancar
        init();

    </script>
</body>
</html>
