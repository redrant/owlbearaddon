<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Platinum Dash v29 - Enhanced Notes</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --bg: #0d0d12; --surf: #15151e; --p: #9d4edd; --p-glow: #c77dff;
            --t: #e0e0e0; --accent: #03dac6; --crit: #00ff88; --fail: #ff4466;
            --border: #2a2a35; --radius: 12px;
        }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: var(--t); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER & TABS */
        header { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; background: var(--surf); border-bottom: 2px solid var(--p); z-index: 50; }
        .tabs { display: flex; gap: 6px; }
        .tab { padding: 8px 15px; background: #000; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; color: #555; font-weight: bold; }
        .tab.active { border-color: var(--p); color: var(--p); box-shadow: 0 0 10px var(--p); }

        /* MAIN LIST */
        #main-view { flex: 1; display: flex; flex-direction: column; padding: 20px; overflow-y: auto; gap: 15px; }
        .bar-add { display: flex; gap: 10px; background: var(--surf); padding: 12px; border-radius: var(--radius); border: 1px solid var(--border); }
        .bar-add input { flex: 1; background: #000; border: 1px solid var(--border); color: #fff; padding: 10px; border-radius: 8px; outline: none; }
        
        .item-card { background: var(--surf); padding: 15px; border-radius: var(--radius); border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: 0.2s; position: relative; }
        .item-card.selected { border-color: var(--crit); background: rgba(0, 255, 136, 0.1); }
        .item-card.hidden-item { opacity: 0.3; border-style: dotted; }

        .folder { background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; margin-bottom: 8px; }
        .folder-h { padding: 14px; font-weight: bold; background: rgba(0,0,0,0.3); display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .folder-c { min-height: 10px; padding: 10px; display: none; }
        .folder.open .folder-c { display: block; }

        /* DASH VIEW */
        #dash-view { position: fixed; inset: 0; background: var(--bg); z-index: 100; display: none; flex-direction: column; }
        .dash-header { padding: 12px 20px; background: var(--surf); display: flex; align-items: center; gap: 15px; border-bottom: 1px solid var(--border); }
        .visual-area { flex: 1; overflow-y: auto; padding: 40px; background: radial-gradient(circle at top, #181825 0%, #0d0d12 100%); }
        .v-line { display: flex; align-items: center; flex-wrap: wrap; gap: 12px; margin-bottom: 15px; min-height: 35px; }

        /* OWLBEAR VARIABLES */
        .v-base { background: #1c1c28; border: 1px solid var(--p); padding: 6px 16px; border-radius: 20px; cursor: pointer; text-align: center; min-width: 90px; }
        .v-base b { color: var(--p-glow); font-size: 10px; display: block; text-transform: uppercase; }
        .v-simple { color: var(--accent); font-weight: bold; background: rgba(0,0,0,0.4); padding: 4px 12px; border-radius: 8px; border: 1px solid #333; }
        .v-roll { color: var(--crit); font-weight: bold; cursor: pointer; background: rgba(0,0,0,0.3); padding: 5px 12px; border-radius: 8px; border: 1px solid #444; }

        /* SLOT MACHINE & MODALS */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .slot-box { display: flex; gap: 12px; justify-content: center; height: 100px; overflow: hidden; margin: 20px 0; }
        .reel { display: flex; flex-direction: column; transition: transform 2.8s cubic-bezier(0.1, 0, 0, 1.1); }
        .face { height: 90px; min-width: 85px; display: flex; align-items: center; justify-content: center; font-size: 40px; font-weight: 900; background: #000; border: 2px solid #333; border-radius: 12px; margin-bottom: 10px; color: #555; }
        .face.green { color: var(--crit); border-color: var(--crit); box-shadow: 0 0 15px var(--crit); }
        .face.red { color: var(--fail); border-color: var(--fail); box-shadow: 0 0 15px var(--fail); }

        /* NUEVA INTERFAZ DE NOTA */
        #note-modal .note-content { 
            background: var(--surf); border: 2px solid var(--p); padding: 30px; border-radius: 20px; 
            max-width: 500px; width: 90%; text-align: center; box-shadow: 0 0 30px rgba(157, 78, 221, 0.2);
            animation: popIn 0.3s ease-out;
        }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .log-ui { height: 160px; background: #07070a; border-top: 2px solid var(--p); padding: 15px; overflow-y: auto; font-size: 13px; }
        .btn-p { background: var(--p); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-s { background: #22222b; color: #aaa; border: 1px solid #3d3d50; padding: 8px 14px; border-radius: 8px; cursor: pointer; }
        .btn-minus { background: #1a1a24; color: var(--p-glow); border: 1px solid var(--p); padding: 4px 10px; border-radius: 8px; font-weight: bold; font-size: 11px; }
    </style>
</head>
<body>

    <div id="auth-screen" style="position:fixed; inset:0; background:var(--bg); z-index:1000; display:flex; align-items:center; justify-content:center;">
        <div style="background:var(--surf); padding:40px; border-radius:20px; border:2px solid var(--p); text-align:center; min-width:320px;">
            <h1 style="color:var(--p); margin:0 0 20px 0;">PLATINUM v29</h1>
            <input type="text" id="user-in" placeholder="Usuario / DM..." style="width:100%; padding:15px; background:#000; border:1px solid #333; color:#fff; border-radius:10px; outline:none;">
            <button onclick="login()" class="btn-p" style="width:100%; margin-top:20px;">INICIAR</button>
        </div>
    </div>

    <div id="dice-modal" class="modal-overlay">
        <div style="text-align:center;">
            <div id="reels-container" class="slot-box"></div>
            <div id="dice-extra" style="color:var(--p-glow); font-size:24px; font-weight:bold; height:30px; margin-bottom:10px;"></div>
            <div id="dice-total" style="font-size:100px; font-weight:900; color:white; text-shadow: 0 0 25px var(--p);">0</div>
            <button onclick="document.getElementById('dice-modal').style.display='none'" class="btn-s" style="margin-top:20px;">CERRAR</button>
        </div>
    </div>

    <div id="note-modal" class="modal-overlay" onclick="this.style.display='none'">
        <div class="note-content" onclick="event.stopPropagation()">
            <h2 id="note-title" style="color: var(--p-glow); margin-top: 0; text-transform: uppercase; letter-spacing: 2px;"></h2>
            <hr style="border: 0; border-top: 1px solid var(--border); margin: 15px 0;">
            <p id="note-body" style="line-height: 1.6; color: var(--t); font-size: 16px; white-space: pre-wrap;"></p>
            <button onclick="document.getElementById('note-modal').style.display='none'" class="btn-p" style="margin-top: 20px; width: 100%;">ENTENDIDO</button>
        </div>
    </div>

    <header>
        <div id="tab-bar" class="tabs"></div>
        <div id="dm-tools" style="display:none; gap:8px;">
            <button onclick="mass('PUNTOS')" class="btn-s" style="color:var(--p)">PTS</button>
            <button onclick="mass('NIVEL')" class="btn-s" style="color:var(--crit)">LVL</button>
            <button onclick="mass('MONEDAS')" class="btn-s" style="color:var(--accent)">MONEDA</button>
            <button onclick="clearLog()" class="btn-s" style="color:var(--fail)">CLEAR LOG</button>
            <button onclick="exportJSON()" class="btn-s">EXP</button>
            <button onclick="importJSON()" class="btn-s">IMP</button>
            <button onclick="bulkDel()" id="btn-bulk" class="btn-s" style="display:none; color:var(--fail)">BORRAR</button>
        </div>
        <div id="user-tag" style="color:var(--p); font-weight:bold; padding:0 15px;"></div>
    </header>

    <div id="main-view">
        <div class="bar-add">
            <input type="text" id="add-name" placeholder="Nombre...">
            <button onclick="add('dash')" class="btn-p">+ DASH</button>
            <button onclick="add('folder')" class="btn-s">+ CARPETA</button>
        </div>
        <div id="master-list" style="flex:1"></div>
        <div id="log-ui" class="log-ui"></div>
    </div>

    <div id="dash-view">
        <div class="dash-header">
            <button onclick="closeDash()" class="btn-s">VOLVER</button>
            <h2 id="d-title" style="flex:1; text-align:center; color:var(--p); margin:0;"></h2>
            <button id="btn-own" onclick="toggleOwn()" class="btn-s">OWNEAR</button>
            <button id="btn-use" onclick="toggleUse()" class="btn-s">USAR</button>
            <button id="btn-mode" onclick="toggleMode()" class="btn-p" style="display:none;">EDITAR</button>
        </div>
        <div id="d-visual" class="visual-area"></div>
        <div id="d-edit" class="visual-area" style="display:none; background:#08080c;">
            <div style="margin-bottom:15px; display:flex; gap:8px; flex-wrap:wrap; background:rgba(255,255,255,0.03); padding:10px; border-radius:10px;">
                <button class="btn-s" onclick="wrap('**','**')">Bold</button>
                <button class="btn-s" onclick="wrap('*','*')">Italic</button>
                <button class="btn-s" onclick="wrap('<g=violet>','</g>')">Glow</button>
                <button class="btn-s" onclick="addNote()">Note</button>
                <button class="btn-s" onclick="wrap('[+1] ','')">[+]</button>
                <button class="btn-s" onclick="wrap('[-1] ','')">[-] ID</button>
                <button class="btn-s" onclick="wrap('[editar]','')">Btn Edit</button>
            </div>
            <textarea id="editor" spellcheck="false" style="width:100%; height:450px; background:#000; color:#fff; border:1px solid var(--border); border-radius:10px; padding:20px; font-size:16px; outline:none; resize:none; line-height:1.5;"></textarea>
            <div style="display:flex; justify-content:flex-end; margin-top:20px;">
                <button onclick="saveDash()" class="btn-p" style="background:var(--crit); color:#000; width:250px;">GUARDAR Y VISUALIZAR</button>
            </div>
        </div>
    </div>

    <script>
        const SB_URL = "https://emqtfhijkywtbwvcdeus.supabase.co", SB_KEY = "sb_publishable_rPFAxYZi5TqK11r3aWGppQ_SpdzF6Kp";
        const sb = window.supabase.createClient(SB_URL, SB_KEY);
        
        let DB = { items: {}, log: [], page: 1, active: {} }, USER = "", CID = null, MODE = 'VIEW', SEL = new Set();
        const IS_DM = (u) => u === "DM" || u === "ADMIN" || u === "MASTER";

        async function login() {
            USER = document.getElementById('user-in').value.trim().toUpperCase();
            if(!USER) return;
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('user-tag').innerText = USER;
            if(IS_DM(USER)) document.getElementById('dm-tools').style.display = 'flex';
            await pull(); setInterval(pull, 2500);
        }

        async function push() { await sb.from('platinum_session').upsert({ id: 1, data: DB }); }
        async function pull() {
            const { data } = await sb.from('platinum_session').select('data').eq('id', 1).single();
            if(data) { if(CID && MODE === 'EDIT') return; DB = data.data; if(!CID) renderList(); else renderDash(); renderTabs(); }
        }

        function renderTabs() {
            const h = document.getElementById('tab-bar'); h.innerHTML = "";
            for(let i=1; i<=5; i++) {
                const b = document.createElement('div'); b.className = `tab ${DB.page===i?'active':''}`;
                b.innerText = `P${i}`; b.onclick = () => { DB.page = i; push(); renderList(); }; h.appendChild(b);
            }
        }

        function renderList() {
            const container = document.getElementById('master-list'); container.innerHTML = "";
            const items = Object.values(DB.items).filter(it => (it.page||1) === DB.page && !it.parentId);
            items.forEach(it => {
                if(it.hidden && !IS_DM(USER)) return;
                if(it.type === 'folder') {
                    const f = document.createElement('div'); f.className = `folder ${it.open?'open':''}`; f.dataset.id = it.id;
                    f.innerHTML = `<div class="folder-h" onclick="toggleFolder('${it.id}')"><span>üìÅ ${it.name}</span>
                        <div>${IS_DM(USER)?`<span style="margin-right:10px" onclick="event.stopPropagation();toggleHide('${it.id}')">${it.hidden?'üëÅÔ∏è‚Äçüó®Ô∏è':'üëÅÔ∏è'}</span> <span onclick="event.stopPropagation();deleteItem('${it.id}')">üóëÔ∏è</span>`:''}</div></div>
                        <div class="folder-c"></div>`;
                    const sub = f.querySelector('.folder-c');
                    Object.values(DB.items).filter(s => s.parentId === it.id).forEach(s => { if(!(it.hidden && !IS_DM(USER))) sub.appendChild(createItemEl(s)); });
                    container.appendChild(f);
                } else container.appendChild(createItemEl(it));
            });
            new Sortable(container, { group: 'nested', animation: 150, onEnd: syncSort });
            document.querySelectorAll('.folder-c').forEach(el => new Sortable(el, { group: 'nested', animation: 150, onEnd: syncSort }));
            updateLog();
        }

        function syncSort(e) { const id=e.item.dataset.id, f=e.to.closest('.folder'); DB.items[id].parentId=f?f.dataset.id:null; push(); }

        function createItemEl(it) {
            const d = document.createElement('div'); d.className = `item-card ${SEL.has(it.id)?'selected':''} ${it.hidden?'hidden-item':''}`; d.dataset.id = it.id;
            d.innerHTML = `<span>üìÑ ${it.name}</span><div style="display:flex;align-items:center;"><small style="color:var(--p);margin-right:10px;">${it.owner||''}</small>
                ${IS_DM(USER)?`<span style="margin-right:10px" onclick="event.stopPropagation();toggleHide('${it.id}')">${it.hidden?'üëÅÔ∏è‚Äçüó®Ô∏è':'üëÅÔ∏è'}</span> <span onclick="event.stopPropagation();deleteItem('${it.id}')">üóëÔ∏è</span>`:''}</div>`;
            d.onclick = (e) => { if(e.shiftKey) { SEL.has(it.id)?SEL.delete(it.id):SEL.add(it.id); document.getElementById('btn-bulk').style.display=SEL.size>0?'block':'none'; renderList(); } else openDash(it.id); };
            return d;
        }

        function openDash(id) { CID=id; MODE='VIEW'; document.getElementById('dash-view').style.display='flex'; renderDash(); }
        function closeDash() { CID=null; document.getElementById('dash-view').style.display='none'; renderList(); }

        function renderDash() {
            const it = DB.items[CID]; if(!it) return closeDash();
            document.getElementById('d-title').innerText = it.name;
            const canEdit = (it.owner === USER || IS_DM(USER));
            document.getElementById('btn-mode').style.display = canEdit ? "block" : "none";
            document.getElementById('btn-mode').innerText = MODE === 'VIEW' ? "EDITAR" : "VISUALIZAR";
            document.getElementById('btn-own').innerText = it.owner === USER ? "LIBERAR" : (it.owner ? `OWNER: ${it.owner}` : "OWNEAR");
            document.getElementById('btn-use').innerText = DB.active[USER] === CID ? "DEJAR" : "USAR";
            document.getElementById('btn-use').style.background = DB.active[USER] === CID ? "var(--crit)" : "var(--surf)";

            if(MODE === 'VIEW') {
                const bases = ["FUE","INT","AGI","FOR","DES","SPD","CAR"]; let eIdx = 0;
                document.getElementById('d-visual').innerHTML = it.content.split('\n').map(line => {
                    let h = line.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\*(.*?)\*/g, '<i>$1</i>')
                        .replace(/<g=(.*?)>(.*?)<\/g>/g, '<span style="color:$1; text-shadow:0 0 10px $1">$2</span>')
                        .replace(/\[note=(.*?)\](.*?)\[\/note\]/g, (m,t,c)=> `<button class="btn-s" style="border-radius:20px; font-size:11px;" onclick="popNote('${t}','${c}')">${t}</button>`)
                        .replace(/\[editar\]/g, () => `<button class="btn-s" style="padding:2px 6px; font-size:10px;" onclick="inlineEdit(${eIdx++})">EDIT</button>`)
                        .replace(/(\d*d\d+[\+\-\*\/A-Z0-9\(\)]*)/gi, f => `<span class="v-roll" onclick="roll('${f}')">${f}</span>`)
                        .replace(/([A-Z]+)=([0-9]+)/gi, (m, k, v) => {
                            k = k.toUpperCase(); if(bases.includes(k)) return `<div class="v-base" onclick="lvlUp('${k}',${v})"><b>${k}</b><span>LVL: ${v} | pt${getPtCost(v)}</span></div>`;
                            return `<span class="v-simple">${k}=${v}</span>`;
                        });
                    h = h.replace(/\[(L\d+|C\d+)?\+(\d+)\]/gi, (m, req, tid) => {
                        const pureText = line.replace(/\[.*?\]/gi,'').trim();
                        return `<button class="btn-p" style="padding:4px 8px; font-size:11px;" onclick="sendTo('${pureText}', '${req||''}', '${tid}')">${req||''}+${tid}</button>`;
                    });
                    h = h.replace(/\[\-(\d+)\]/gi, (m, tid) => `<span class="btn-minus">[-${tid}]</span>`);

                    return `<div class="v-line">${h}</div>`;
                }).join('');
                document.getElementById('d-visual').style.display='block'; document.getElementById('d-edit').style.display='none';
            } else {
                document.getElementById('d-visual').style.display='none'; document.getElementById('d-edit').style.display='block';
            }
        }

        async function sendTo(text, req, tid) {
            const activeCID = DB.active[USER];
            if(!activeCID) return alert("Primero marca un Dash como 'USAR'");
            const myDash = DB.items[activeCID];
            const myVars = getVars(myDash.content);

            if(req.startsWith('L')) {
                const v = parseInt(req.substring(1));
                if((myVars['NIVEL']||0) < v) return alert("Nivel insuficiente: " + v);
            } else if(req.startsWith('C')) {
                const v = parseInt(req.substring(1));
                if((myVars['MONEDAS']||0) < v) return alert("Monedas insuficientes: " + v);
                myDash.content = myDash.content.replace(new RegExp(`MONEDAS=${myVars['MONEDAS']}`, 'i'), `MONEDAS=${myVars['MONEDAS'] - v}`);
            }

            let found = false;
            Object.values(DB.items).forEach(it => {
                const pattern = new RegExp(`\\[\\-${tid}\\]`, 'i');
                if(pattern.test(it.content)) {
                    const lines = it.content.split('\n');
                    const newLines = [];
                    lines.forEach(line => {
                        newLines.push(line);
                        if(pattern.test(line)) newLines.push(text);
                    });
                    it.content = newLines.join('\n');
                    found = true;
                }
            });
            if(!found) alert("No se encontr√≥ receptor con ID: [-" + tid + "]");
            else { push(); renderDash(); }
        }

        function inlineEdit(idx) {
            const it = DB.items[CID]; let c = 0;
            const val = prompt("Nuevo contenido:"); if(val === null) return;
            it.content = it.content.replace(/\[editar\]/g, (m) => (c++ === idx) ? val : m);
            push().then(renderDash);
        }

        function roll(formula) {
            const it = DB.items[CID], vs = getVars(it.content);
            let rf = formula.toUpperCase();
            Object.keys(vs).forEach(k => rf = rf.replace(new RegExp(`\\b${k}\\b`,'g'), vs[k]));
            
            const match = rf.match(/(\d+)D(\d+)/i) || rf.match(/D(\d+)/i); if(!match) return;
            const n = match[1]?parseInt(match[1]):1, faces = parseInt(match[match.length-1]), results = [];
            let sumFaces = 0; for(let i=0; i<n; i++){ const r = Math.floor(Math.random()*faces)+1; results.push(r); sumFaces += r; }
            
            const totalFinal = eval(rf.replace(/(\d*)D\d+/i, sumFaces));
            const extra = totalFinal - sumFaces;

            document.getElementById('dice-total').innerText = "0";
            document.getElementById('dice-extra').innerText = "";
            document.getElementById('dice-modal').style.display = 'flex';
            const reels = document.getElementById('reels-container'); reels.innerHTML = "";

            results.forEach((r, i) => {
                const reel = document.createElement('div'); reel.className = 'reel';
                for(let x=0; x<15; x++) reel.innerHTML += `<div class="face">${Math.floor(Math.random()*faces)+1}</div>`;
                reel.innerHTML += `<div class="face ${r===1?'red':r===faces?'green':''}">${r}</div>`;
                reels.appendChild(reel);
                setTimeout(() => reel.style.transform = `translateY(-${reel.scrollHeight - 90}px)`, i*150);
            });

            setTimeout(() => {
                if(extra !== 0) document.getElementById('dice-extra').innerText = (extra > 0 ? "+ " : "- ") + Math.abs(extra);
                document.getElementById('dice-total').innerText = totalFinal;
                DB.log.unshift({ u:USER, d:it.name, t:totalFinal, f:formula, res:results, max:faces });
                push(); updateLog();
            }, 2600);
        }

        function getPtCost(l) { if(l<4) return 1; if(l<7) return 2; if(l<10) return 3; return Math.floor((l-10)/3)+4; }
        function getVars(t) { const v={}; const ms=t.matchAll(/([A-Z]+)=([0-9]+)/gi); for(const m of ms) v[m[1].toUpperCase()]=parseInt(m[2]); return v; }

        function lvlUp(stat, current) {
            const it = DB.items[CID], vs = getVars(it.content);
            const n = parseInt(prompt(`Niveles a subir de ${stat}:`, "1")); if(!n) return;
            let cost = 0; for(let i=0; i<n; i++) cost += getPtCost(current + i);
            if((vs['PUNTOS']||0) < cost) return alert("Faltan puntos");

            let nc = it.content.replace(new RegExp(`${stat}=${current}`,'i'), `${stat}=${current+n}`)
                               .replace(new RegExp(`PUNTOS=${vs['PUNTOS']}`,'i'), `PUNTOS=${vs['PUNTOS']-cost}`);
            
            if(stat==='FOR') nc = modV(nc, 'HP', n*10);
            if(stat==='INT') nc = modV(nc, 'ST', n*10);
            if(stat==='DES') nc = modV(nc, 'ST', n*5);
            if(stat==='FUE') { nc = modV(nc, 'ST', n*5); nc = modV(nc, 'SL', Math.floor((current%2 + n)/2)); }
            if(stat==='AGI') { if((current%2 + n) >= 2) nc = modV(nc, 'FT', Math.floor((current%2 + n)/2)*5); }
            
            it.content = nc; push().then(renderDash);
        }

        function modV(t, k, a) { const v=getVars(t); return v[k]!==undefined ? t.replace(new RegExp(`${k}=${v[k]}`,'i'), `${k}=${v[k]+a}`) : t+`\n${k}=${a}`; }

        function mass(key) {
            const val = parseInt(prompt(`A√±adir ${key} a todos:`)); if(isNaN(val)) return;
            Object.values(DB.items).forEach(it => {
                const vs = getVars(it.content);
                if(vs[key] !== undefined) it.content = it.content.replace(new RegExp(`${key}=${vs[key]}`, 'i'), `${key}=${vs[key]+val}`);
            });
            push().then(renderList);
        }

        function toggleMode() { MODE=(MODE==='VIEW'?'EDIT':'VIEW'); if(MODE==='EDIT') document.getElementById('editor').value=DB.items[CID].content; renderDash(); }
        function saveDash() { DB.items[CID].content = document.getElementById('editor').value; push().then(()=> { MODE='VIEW'; renderDash(); }); }
        function wrap(a,b) { const e=document.getElementById('editor'), s=e.selectionStart, v=e.value; e.value=v.slice(0,s)+a+v.slice(s,e.selectionEnd)+b+v.slice(e.selectionEnd); e.focus(); }
        
        // GESTI√ìN DE NOTAS ACTUALIZADA
        function addNote() { const t=prompt("T√çTULO DE NOTA"), c=prompt("Contenido (usa doble espacio para enter)"); if(t&&c) wrap(`[note=${t}]${c.replace(/\n\n/g,'  ')}[/note]`, ''); }
        function popNote(t,c) { 
            document.getElementById('note-title').innerText = t;
            document.getElementById('note-body').innerText = c.replace(/  /g, '\n');
            document.getElementById('note-modal').style.display = 'flex';
        }

        function toggleOwn() { const it=DB.items[CID]; it.owner = (it.owner===USER?null:USER); push().then(renderDash); }
        function toggleUse() { DB.active[USER] = (DB.active[USER]===CID?null:CID); push().then(renderDash); }
        function toggleFolder(id) { DB.items[id].open = !DB.items[id].open; renderList(); }
        function toggleHide(id) { DB.items[id].hidden = !DB.items[id].hidden; push().then(renderList); }
        function deleteItem(id) { if(confirm("¬øEliminar?")) { delete DB.items[id]; push().then(renderList); } }
        function clearLog() { DB.log=[]; push().then(renderList); }
        
        function updateLog() {
            const h = document.getElementById('log-ui'); h.innerHTML = "";
            DB.log.slice(0,12).forEach(l => {
                h.innerHTML += `<div style="border-bottom:1px solid #222; padding:5px 0;"><b>${l.u}</b> | ${l.d} | <span style="color:var(--p)">${l.t}</span> (${l.f})<br>` + 
                l.res.map(r => `<span style="color:${r===1?'#ff4466':r===l.max?'#00ff88':'#777'}; border:1px solid #333; padding:0 4px; margin:2px; border-radius:4px; background:#000;">${r}</span>`).join('') + `</div>`;
            });
        }

        function add(type) {
            const id = 'id' + Date.now(); const name = document.getElementById('add-name').value || (type==='dash'?'Personaje':'Carpeta');
            DB.items[id] = { id, type, name, content: "", page: DB.page, owner: (type==='dash'?USER:null), hidden: false, parentId: null, open: false };
            document.getElementById('add-name').value = ""; push().then(renderList);
        }

        function bulkDel() { if(confirm("¬øBorrar seleccionados?")) { SEL.forEach(id => delete DB.items[id]); SEL.clear(); push().then(renderList); } }
        function exportJSON() { const data = JSON.stringify(Object.values(DB.items).filter(it => it.page === DB.page)); const b = new Blob([data], {type: "application/json"}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `page_${DB.page}.json`; a.click(); }
        function importJSON() { const inp = document.createElement('input'); inp.type = 'file'; inp.onchange = e => { const reader = new FileReader(); reader.onload = () => { JSON.parse(reader.result).forEach(it => { it.id = 'id'+Date.now()+Math.random(); it.page = DB.page; DB.items[it.id] = it; }); push().then(renderList); }; reader.readAsText(e.target.files[0]); }; inp.click(); }
    </script>
</body>
</html>
