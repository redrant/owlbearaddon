<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/@owlbear-rodeo/sdk"></script>
    <style>
        :root { --primary: #bb86fc; --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --accent: #03dac6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; }
        h2 { color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 5px; }
        .menu-section { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        input, textarea { background: #2c2c2c; border: 1px solid #444; color: white; padding: 10px; border-radius: 6px; width: 100%; box-sizing: border-box; }
        button { background: var(--primary); color: black; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .dash-button { background: var(--card); padding: 15px; margin: 10px 0; border-radius: 8px; display: block; width: 100%; text-align: left; border: 1px solid #333; color: var(--text); font-size: 16px; cursor: pointer; transition: 0.2s; }
        .dash-button:hover { border-color: var(--primary); background: #252525; }
        .tab-bar { display: flex; gap: 5px; margin-bottom: 10px; border-bottom: 1px solid #444; }
        .tab { padding: 8px 12px; background: #333; cursor: pointer; border-radius: 8px 8px 0 0; font-size: 0.8em; }
        .tab.active { background: var(--primary); color: black; }
        #preview-area { background: #1a1a1a; padding: 15px; border-radius: 8px; border: 1px dashed #555; min-height: 40px; margin-top: 10px; line-height: 1.6; }
        .dice-roll { color: var(--primary); font-weight: bold; cursor: pointer; text-decoration: underline; padding: 2px 4px; background: rgba(187,134,252,0.1); border-radius: 4px; }
        .result-box { background: #000; padding: 12px; border: 2px solid var(--accent); margin-top: 15px; border-radius: 8px; }
        .stat-tag { color: var(--accent); font-weight: bold; }
    </style>
</head>
<body>
    <div id="view-list">
        <h2>Mis Dashes</h2>
        <div class="menu-section">
            <input type="text" id="dashName" placeholder="Nombre del personaje...">
            <button onclick="createDash()">+ CREAR NUEVO DASH</button>
        </div>
        <div id="list-container"></div>
    </div>

    <div id="view-details" style="display:none;">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom:10px;">
            <button onclick="showList()" style="background:#444; color:white;">â¬… Volver</button>
            <h3 id="current-title" style="margin:0; color:var(--primary);"></h3>
            <button onclick="deleteCurrent()" style="background:#600; color:white; font-size:10px;">Borrar</button>
        </div>
        <div class="tab-bar" id="tab-bar"></div>
        <textarea id="editor" rows="8" oninput="handleUpdate()" placeholder="FUE=10&#10;Espada: 1d20+FUE"></textarea>
        <div id="preview-area"></div>
        <div id="dice-output"></div>
    </div>

    <script>
        let state = { dashes: {}, currentId: null, currentPage: 0, stats: {} };
        const STORAGE_KEY = "dash_plus_data";

        // 1. INICIALIZACIÃ“N DUAL
        async function init() {
            if (typeof OBR !== "undefined" && window.location.hostname.includes("owlbear")) {
                OBR.onReady(async () => {
                    const meta = await OBR.scene.getMetadata();
                    state.dashes = meta["com.dash.data"] || {};
                    renderList();
                    OBR.scene.onMetadataChange(m => { state.dashes = m["com.dash.data"] || {}; renderList(); });
                });
            } else {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) state.dashes = JSON.parse(saved);
                renderList();
            }
        }

        // 2. GUARDADO
        async function save() {
            if (typeof OBR !== "undefined" && OBR.isReady) {
                await OBR.scene.setMetadata({ "com.dash.data": state.dashes });
            } else {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state.dashes));
                renderList();
            }
        }

        function createDash() {
            const name = document.getElementById('dashName').value;
            if(!name) return;
            const id = "d" + Date.now();
            state.dashes[id] = { name, pages: [{title: 'Stats', content: 'FUE=10\n1d20+FUE'}] };
            document.getElementById('dashName').value = '';
            save();
        }

        function renderList() {
            const container = document.getElementById('list-container');
            container.innerHTML = '';
            Object.keys(state.dashes).forEach(id => {
                const btn = document.createElement('button');
                btn.className = 'dash-button';
                btn.innerText = "ðŸ“‚ " + state.dashes[id].name;
                btn.onclick = () => openDash(id);
                container.appendChild(btn);
            });
        }

        function openDash(id) {
            state.currentId = id;
            document.getElementById('view-list').style.display = 'none';
            document.getElementById('view-details').style.display = 'block';
            document.getElementById('current-title').innerText = state.dashes[id].name;
            renderEditor();
        }

        function renderEditor() {
            const page = state.dashes[state.currentId].pages[0];
            document.getElementById('editor').value = page.content;
            processContent(page.content);
        }

        function handleUpdate() {
            const content = document.getElementById('editor').value;
            state.dashes[state.currentId].pages[0].content = content;
            processContent(content);
            save();
        }

        function processContent(text) {
            state.stats = {};
            // Captura variables FUE=10
            text.replace(/([A-Z]+)\s*=\s*(\d+)/gi, (m, name, val) => {
                state.stats[name.toUpperCase()] = parseInt(val);
            });

            // Renderiza preview con dados clicables
            let html = text.replace(/([A-Z]+)\s*=\s*(\d+)/gi, '<span class="stat-tag">$1=$2</span>');
            html = html.replace(/(\d*d\d+[\+\-\*\/A-Z0-9]*)/gi, (f) => {
                return `<span class="dice-roll" onclick="roll('${f}')">${f}</span>`;
            });
            document.getElementById('preview-area').innerHTML = html.replace(/\n/g, '<br>');
        }

        function roll(formula) {
            let f = formula.toUpperCase();
            // Reemplaza variables
            Object.keys(state.stats).forEach(s => {
                f = f.replace(new RegExp(`\\b${s}\\b`, 'g'), state.stats[s]);
            });

            const diceMatch = f.match(/(\d*)D(\d+)/i);
            if (!diceMatch) return;

            const n = parseInt(diceMatch[1]) || 1;
            const s = parseInt(diceMatch[2]);
            let totalDice = 0;
            for(let i=0; i<n; i++) totalDice += Math.floor(Math.random()*s)+1;

            let final;
            try {
                const math = f.replace(diceMatch[0], "");
                final = eval(totalDice + math.replace(/[^0-9\+\-\*\/\(\)]/g, ''));
            } catch { final = totalDice; }

            document.getElementById('dice-output').innerHTML = `
                <div class="result-box" onclick="this.innerHTML=''">
                    <b>${formula}</b><br>
                    <span style="font-size:20px;">TOTAL: ${final}</span>
                </div>`;
        }

        function showList() {
            state.currentId = null;
            document.getElementById('view-list').style.display = 'block';
            document.getElementById('view-details').style.display = 'none';
        }

        function deleteCurrent() {
            if(confirm("Â¿Borrar dash?")) { delete state.dashes[state.currentId]; save(); showList(); }
        }

        init();
    </script>
</body>
</html>
