<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<script src="https://unpkg.com/@owlbear-rodeo/sdk/dist/obr.js"></script>

<style>
:root{
 --bg:#0d0d0f; --card:#1a1a1d; --txt:#eee;
 --p:#bb86fc; --accent:#03dac6;
 --crit:#00ff88; --fail:#ff4466;
}
body{margin:0;padding:10px;background:var(--bg);color:var(--txt);font-family:Segoe UI}
button,input,textarea{background:#222;color:white;border:1px solid #333;border-radius:6px;padding:6px}
button:hover{background:var(--p);color:black;cursor:pointer}
.card{background:var(--card);border:1px solid #333;border-radius:10px;padding:10px;margin-bottom:8px}
.dice{color:var(--p);font-weight:bold;cursor:pointer;text-decoration:underline}
.glow{text-shadow:0 0 10px currentColor}
#overlay{position:fixed;inset:0;background:rgba(0,0,0,.9);display:none;align-items:center;justify-content:center}
.modal{background:#1e1e1e;border:2px solid var(--p);padding:20px;border-radius:15px;min-width:300px}
.log{font-size:12px;border-top:1px solid #333;margin-top:10px;padding-top:6px}
.slot{display:flex;gap:5px;margin:5px 0}
</style>
</head>

<body>

<h2 style="color:var(--p)">Smart Dashboards</h2>

<div id="list"></div>
<button onclick="newDash()">âž• Nuevo Dash</button>

<hr>

<div id="dashView" style="display:none">
<h3 id="dashTitle"></h3>

<div id="editorWrap">
<textarea id="editor" style="width:100%;height:160px" oninput="parse()"></textarea>
</div>

<div id="preview" class="card"></div>

<div id="slots"></div>

<h4>ðŸ“œ Log de Dados</h4>
<div id="log" class="card"></div>
<button onclick="clearLog()">RESET LOG</button>

<button onclick="back()">â¬… Volver</button>
</div>

<div id="overlay" onclick="this.style.display='none'">
 <div class="modal" onclick="event.stopPropagation()" id="modal"></div>
</div>

<script>
const KEY="dash.smart.data";
let state={dashes:{},id:null,stats:{},user:"Anon",role:"player",log:[]};

OBR.onReady(async()=>{
 const p=await OBR.player.getSelf();
 state.user=p.name;
 state.role=p.role||"player";
 const m=await OBR.scene.getMetadata();
 Object.assign(state,m[KEY]||state);
 renderList();
});

function save(){OBR.scene.setMetadata({[KEY]:state})}

function newDash(){
 const id="d"+Date.now();
 state.dashes[id]={name:"Nuevo Dash",content:"FUE=10\n1d20+FUE",owner:state.user};
 save();renderList();
}

function renderList(){
 const l=document.getElementById("list");l.innerHTML="";
 Object.entries(state.dashes).forEach(([id,d])=>{
  const c=document.createElement("div");
  c.className="card";
  c.textContent=d.name;
  c.onclick=()=>openDash(id);
  l.appendChild(c);
 });
}

function openDash(id){
 state.id=id;
 const d=state.dashes[id];
 document.getElementById("dashView").style.display="block";
 document.getElementById("dashTitle").textContent=d.name;
 document.getElementById("editor").value=d.content;
 document.getElementById("editorWrap").style.display=
   (state.role==="dm"||d.owner===state.user)?"block":"none";
 parse();
}

function back(){document.getElementById("dashView").style.display="none"}

function parse(){
 const d=state.dashes[state.id];
 d.content=document.getElementById("editor").value;
 state.stats={};
 d.content.replace(/([A-Z]+)=([0-9]+)/g,(m,n,v)=>state.stats[n]=+v);
 let html=d.content
  .replace(/<g=(.*?)>(.*?)<\/g>/g,'<span class="glow" style="color:$1">$2</span>')
  .replace(/\*\*(.*?)\*\*/g,'<b>$1</b>')
  .replace(/(\d*d\d+[\+\-\*A-Z0-9\(\)]*)/gi,f=>`<span class="dice" onclick="roll('${f}')">${f}</span>`);
 document.getElementById("preview").innerHTML=html.replace(/\n/g,"<br>");
 buildSlots(d.content);
 save();
}

function buildSlots(txt){
 const s=document.getElementById("slots");s.innerHTML="<h4>ðŸ§© ExtraCasillas</h4>";
 txt.replace(/\[slot=(.*?)\](.*)/g,(m,n,v)=>{
  const d=document.createElement("div");
  d.className="slot";
  d.innerHTML=`<b>${n}</b><input oninput="slotInput('${n}',this.value)" placeholder="${v.trim()}">`;
  s.appendChild(d);
 });
}

function slotInput(name,val){
 const d=state.dashes[state.id];
 d.content+=`\n${name}: ${val}`;
 parse();
}

function roll(formula){
 let f=formula.toUpperCase();
 Object.entries(state.stats).forEach(([k,v])=>f=f.replace(k,v));
 const [,n,s]=f.match(/(\d*)D(\d+)/i);
 let r=[],sum=0;
 for(let i=0;i<(+n||1);i++){
  const x=Math.floor(Math.random()*s)+1;
  sum+=x;
  r.push(`<span style="color:${x==1?'var(--fail)':x==s?'var(--crit)':'#fff'}">${x}</span>`);
 }
 state.log.unshift(`${state.user}: ${formula} â†’ ${sum}`);
 renderLog();
 document.getElementById("modal").innerHTML=`<h3>${formula}</h3>[${r.join(",")}]<h1>${sum}</h1>`;
 document.getElementById("overlay").style.display="flex";
 save();
}

function renderLog(){
 document.getElementById("log").innerHTML=state.log.slice(0,20).join("<br>");
}

function clearLog(){
 if(state.role!=="dm")return;
 state.log=[];renderLog();save();
}
</script>
</body>
</html>
