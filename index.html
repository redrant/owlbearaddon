<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/@owlbear-rodeo/sdk/dist/obr.js"></script>
    <style>
        :root { 
            --p: #bb86fc; --bg: #0d0d0f; --surf: #1a1a1d; --t: #f0f0f0; 
            --accent: #03dac6; --crit: #00ff88; --fail: #ff4466; --folder: #ff9800;
        }
        
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--t); margin: 0; padding: 10px; user-select: none; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* HEADER & SIGNATURE */
        .header-main { text-align: center; border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 10px; position: relative; }
        .version { font-size: 9px; color: var(--p); font-weight: bold; letter-spacing: 2px; }
        .signature { font-size: 16px; font-weight: bold; color: var(--p); text-shadow: 0 0 10px var(--p); }

        /* CONTROLS */
        .input-group { display: flex; gap: 5px; margin-bottom: 10px; }
        input[type="text"] { flex: 1; padding: 10px; background: #222; color: white; border: 1px solid #444; border-radius: 8px; outline: none; }
        .btn { border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 11px; color: #000; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
        .btn-p { background: var(--p); } 
        .btn-f { background: var(--folder); }
        .btn-ghost { background: transparent; color: var(--t); border: 1px solid #444; }

        /* LIST & FOLDERS */
        #list-container { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; padding-bottom: 10px; }
        .item-card { padding: 10px; border-radius: 8px; border: 1px solid #252529; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: #16161a; position: relative; }
        .folder-card { border-left: 4px solid var(--folder); color: var(--folder); font-weight: bold; background: #1d170e; }
        .dash-card { border-left: 4px solid var(--p); }
        .child-item { margin-left: 20px; }
        .hidden { display: none !important; }

        /* EDITOR & PREVIEW */
        #view-details { display: none; flex-direction: column; height: 100%; position: relative; z-index: 10; background: var(--bg); }
        .editor-wrap { flex: 1; display: flex; flex-direction: column; }
        textarea { flex: 1; background: #080808; color: #bbb; padding: 15px; border: 1px solid #333; border-radius: 0 0 8px 8px; font-family: 'Consolas', monospace; resize: none; outline: none; line-height: 1.5; font-size: 14px; }
        .toolbar { display: flex; gap: 4px; background: #1e1e1e; padding: 8px; border-radius: 8px 8px 0 0; border: 1px solid #333; flex-wrap: wrap; }
        
        #preview { flex: 1; padding: 20px; overflow-y: auto; background: #0d0d0f; border: 1px solid #333; border-radius: 8px; line-height: 1.6; display: none; white-space: normal; word-wrap: break-word; }

        /* VISUAL ELEMENTS */
        .glow { font-weight: bold; }
        .note-btn { background: rgba(187,134,252,0.15); color: var(--p); border: 1px solid var(--p); padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; margin: 2px; font-weight: bold; }
        .cb-box { display: flex; align-items: center; background: rgba(3,218,198,0.05); padding: 8px; border-radius: 6px; margin: 5px 0; border-left: 3px solid var(--accent); }
        .cb-check { width: 18px; height: 18px; margin-right: 10px; accent-color: var(--accent); cursor: pointer; }
        .roll-link { color: var(--accent); font-weight: bold; cursor: pointer; text-decoration: underline dotted; }

        /* LOG PANEL */
        .log-area { height: 130px; background: #000; border: 1px solid #222; border-radius: 8px; margin-top: 5px; display: flex; flex-direction: column; }
        .log-header { font-size: 9px; padding: 5px 10px; background: #111; color: #666; display: flex; justify-content: space-between; align-items: center; }
        #log-content { flex: 1; overflow-y: auto; padding: 8px; font-size: 11px; font-family: monospace; }
        .log-row { border-bottom: 1px solid #111; padding: 4px 0; color: #ddd; }
        .log-dice { color: #777; font-size: 10px; display: block; }

        /* MODAL */
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 999; }
        .modal { background: #1a1a1d; border: 1px solid #444; padding: 20px; border-radius: 12px; width: 85%; max-width: 400px; box-shadow: 0 10px 40px #000; }
    </style>
</head>
<body>

    <div id="view-list">
        <div class="header-main">
            <div class="version">VERSION 1.0.0v</div>
            <div class="signature">My Dashesh - By Redrant :v</div>
        </div>
        
        <div class="input-group">
            <input type="text" id="itemName" placeholder="Nombre de dash o carpeta...">
            <button onclick="createNew('dash')" class="btn btn-p">DASH</button>
            <button onclick="createNew('folder')" class="btn btn-f">CARPETA</button>
        </div>

        <div id="list-container"></div>

        <div class="log-area">
            <div class="log-header">
                DICE LOG GLOBAL
                <button onclick="clearGlobalLog()" class="btn btn-ghost" style="padding: 2px 5px; font-size: 8px;">REINICIAR LOG</button>
            </div>
            <div id="log-content"></div>
        </div>
    </div>

    <div id="view-details">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom:10px;">
            <button onclick="closeDetails()" class="btn btn-ghost">‚¨Ö VOLVER</button>
            <div id="detail-title" class="signature" style="font-size:14px;"></div>
            <button onclick="openOwnerMenu()" class="btn btn-ghost">üë§ DUE√ëO</button>
        </div>
        
        <button onclick="toggleVisual()" id="mode-btn" style="width:100%; padding:12px; background:var(--p); color:#000; font-weight:bold; border:none; border-radius:8px; cursor:pointer; margin-bottom:10px; letter-spacing: 1px;">VISUALIZAR</button>

        <div id="editor-ui" class="editor-wrap">
            <div class="toolbar">
                <button class="btn btn-ghost" onclick="ins('[cb] ','')">üîò CasillaPro+</button>
                <button class="btn btn-ghost" onclick="ins('[note=TITULO]','[/note]')">üìù NotaPro+</button>
                <button class="btn btn-ghost" onclick="wrap('<g=gold>','</g>')">‚ú® Glow</button>
                <button class="btn btn-ghost" onclick="wrap('**','**')"><b>B</b></button>
                <button class="btn btn-ghost" onclick="wrap('*','*')"><i>I</i></button>
                <button class="btn btn-p" onclick="deleteCurrent()" style="background:var(--fail); color:white; margin-left:auto;">BORRAR</button>
            </div>
            <textarea id="editor" oninput="saveContent()"></textarea>
        </div>
        <div id="preview"></div>
    </div>

    <div id="modal-overlay" class="overlay" onclick="this.style.display='none'">
        <div class="modal" onclick="event.stopPropagation()" id="modal-body"></div>
    </div>

    <script>
        const METADATA_KEY = "com.mydashes.v100.data";
        const LOG_KEY = "com.mydashes.v100.log";
        
        let state = { 
            items: {}, 
            log: [], 
            collapsed: {}, 
            currentId: null, 
            isEditing: true,
            uid: 'local',
            uname: 'Jugador',
            draggedId: null
        };

        // 1. INICIALIZACI√ìN
        async function init() {
            try {
                if (window.location.search.includes('obr')) {
                    await OBR.onReady(async () => {
                        state.uid = await OBR.player.getId();
                        state.uname = await OBR.player.getName();
                        
                        OBR.scene.onMetadataChange((metadata) => {
                            const data = metadata[METADATA_KEY] || { items: {}, collapsed: {} };
                            state.items = data.items;
                            state.collapsed = data.collapsed;
                            state.log = metadata[LOG_KEY] || [];
                            renderAll();
                        });

                        const initialMetadata = await OBR.scene.getMetadata();
                        const data = initialMetadata[METADATA_KEY] || { items: {}, collapsed: {} };
                        state.items = data.items;
                        state.collapsed = data.collapsed;
                        state.log = initialMetadata[LOG_KEY] || [];
                        renderAll();
                    });
                } else {
                    // Modo Web Local para pruebas
                    const localData = localStorage.getItem(METADATA_KEY);
                    if(localData) state.items = JSON.parse(localData);
                    renderAll();
                }
            } catch(e) { console.error("Error init:", e); }
        }

        // 2. PERSISTENCIA
        async function sync() {
            if (window.OBR && OBR.scene) {
                await OBR.scene.setMetadata({
                    [METADATA_KEY]: { items: state.items, collapsed: state.collapsed },
                    [LOG_KEY]: state.log
                });
            } else {
                localStorage.setItem(METADATA_KEY, JSON.stringify(state.items));
                renderAll();
            }
        }

        // 3. LOGICA DE CREACI√ìN Y CARPETAS
        function createNew(type) {
            const nameInput = document.getElementById('itemName');
            const name = nameInput.value.trim() || (type === 'folder' ? "Nueva Carpeta" : "Nuevo Dash");
            const id = "id_" + Date.now() + Math.random().toString(36).substr(2, 5);
            
            state.items[id] = {
                id,
                type,
                name,
                content: type === 'dash' ? `# ${name}\nFUE=10\n1d20+FUE` : "",
                parent: null,
                owner: null
            };
            
            nameInput.value = "";
            sync();
        }

        function renderAll() {
            const container = document.getElementById('list-container');
            container.innerHTML = '';
            
            const allItems = Object.values(state.items);
            
            // Primero carpetas
            allItems.filter(i => i.type === 'folder').forEach(folder => {
                const folderEl = createCardElement(folder);
                container.appendChild(folderEl);
                
                // Hijos de esta carpeta
                allItems.filter(i => i.parent === folder.id).forEach(child => {
                    const childEl = createCardElement(child, true, state.collapsed[folder.id]);
                    container.appendChild(childEl);
                });
            });

            // Luego dashes sin carpeta
            allItems.filter(i => i.type === 'dash' && !i.parent).forEach(dash => {
                const dashEl = createCardElement(dash);
                container.appendChild(dashEl);
            });

            renderLog();
            if(state.currentId) updateDetailsUI();
        }

        function createCardElement(item, isChild = false, isHidden = false) {
            const div = document.createElement('div');
            div.className = `item-card ${item.type === 'folder' ? 'folder-card' : 'dash-card'} ${isChild ? 'child-item' : ''} ${isHidden ? 'hidden' : ''}`;
            div.draggable = true;
            
            const icon = item.type === 'folder' ? (state.collapsed[item.id] ? 'üìÅ' : 'üìÇ') : 'üìÑ';
            div.innerHTML = `<span>${icon} ${item.name}</span> ${item.owner ? '<span style="font-size:10px; opacity:0.5;">üë§</span>' : ''}`;
            
            div.onclick = (e) => {
                e.stopPropagation();
                if(item.type === 'folder') {
                    state.collapsed[item.id] = !state.collapsed[item.id];
                    sync();
                } else {
                    openDash(item.id);
                }
            };

            // Drag & Drop para meter en carpetas
            div.ondragstart = () => { state.draggedId = item.id; };
            div.ondragover = (e) => e.preventDefault();
            div.ondrop = (e) => {
                e.preventDefault();
                if(state.draggedId === item.id) return;
                if(item.type === 'folder') {
                    state.items[state.draggedId].parent = item.id;
                } else {
                    state.items[state.draggedId].parent = null;
                }
                sync();
            };

            return div;
        }

        // 4. EDITOR Y VISUALIZADOR
        function openDash(id) {
            state.currentId = id;
            state.isEditing = true;
            document.getElementById('view-list').style.display = 'none';
            document.getElementById('view-details').style.display = 'flex';
            updateDetailsUI();
        }

        function updateDetailsUI() {
            const item = state.items[state.currentId];
            if(!item) return closeDetails();
            
            document.getElementById('detail-title').innerText = item.name.toUpperCase();
            document.getElementById('editor-ui').style.display = state.isEditing ? 'flex' : 'none';
            document.getElementById('preview').style.display = state.isEditing ? 'none' : 'block';
            document.getElementById('mode-btn').innerText = state.isEditing ? "VISUALIZAR" : "EDITAR";
            
            if(state.isEditing) {
                const area = document.getElementById('editor');
                if(document.activeElement !== area) area.value = item.content;
            } else {
                parsePreview(item.content);
            }
        }

        function saveContent() {
            if(state.currentId) {
                state.items[state.currentId].content = document.getElementById('editor').value;
                // Debounce simple para no saturar OBR
                clearTimeout(window.saveTimer);
                window.saveTimer = setTimeout(sync, 500);
            }
        }

        function toggleVisual() {
            state.isEditing = !state.isEditing;
            updateDetailsUI();
        }

        // 5. PARSER (L√≥gica de dados, variables y etiquetas)
        function parsePreview(text) {
            const stats = {};
            // Extraer variables: FUE=10
            text.replace(/(\w+)\s*=\s*([\-\d]+)/g, (m, key, val) => {
                stats[key.toUpperCase()] = parseInt(val);
            });

            let html = text
                .replace(/  /g, '<br>') // Doble espacio = rengl√≥n
                .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
                .replace(/\*(.*?)\*/g, '<i>$1</i>')
                .replace(/<g=(.*?)>(.*?)<\/g>/g, '<span class="glow" style="text-shadow: 0 0 10px $1, 0 0 5px $1; color:white;">$2</span>')
                .replace(/\[note=(.*?)\](.*?)\[\/note\]/gs, (m, title, content) => {
                    const cleanContent = content.replace(/\n/g, '<br>').replace(/'/g, "\\'");
                    return `<button class="note-btn" onclick="showModal('${title}', '${cleanContent}')">${title}</button>`;
                })
                .replace(/\[cb\]\s*(.*?)(?:\n|$)/gi, (m, loot) => {
                    const cleanLoot = loot.trim().replace(/'/g, "\\'");
                    return `<div class="cb-box"><input type="checkbox" class="cb-check" onclick="transferLoot('${cleanLoot}', this)"><span>${loot}</span></div>`;
                })
                // L√≥gica de dados: 1d20+FUE, +5FUE, (FUE*2)
                .replace(/(\d*d\d+[\+\-\*\/\d\w\(\)]*|[\+\-]\d+\w+)/gi, (formula) => {
                    return `<span class="roll-link" onclick="handleRoll('${formula}', ${JSON.stringify(stats)})">${formula}</span>`;
                });

            document.getElementById('preview').innerHTML = html.replace(/\n/g, '<br>');
        }

        // 6. SISTEMA DE DADOS AVANZADO
        async function handleRoll(formula, stats) {
            let processed = formula.toUpperCase();
            
            // 1. Reemplazar variables (FUE -> 10)
            for (let s in stats) {
                const regex = new RegExp(`\\b${s}\\b`, 'g');
                processed = processed.replace(regex, stats[s]);
            }

            // 2. Resolver tiradas XdY
            let diceDetails = [];
            processed = processed.replace(/(\d*)D(\d+)/g, (m, count, sides) => {
                const n = parseInt(count) || 1;
                const s = parseInt(sides);
                let total = 0;
                let rolls = [];
                for(let i=0; i<n; i++) {
                    const r = Math.floor(Math.random() * s) + 1;
                    rolls.push(r);
                    total += r;
                }
                diceDetails.push(`(${rolls.join('+')})`);
                return total;
            });

            // 3. Evaluar resultado matem√°tico final
            let result = 0;
            try {
                // Sanitizar string para eval (solo n√∫meros y operadores)
                const safeEval = processed.replace(/[^-()\d/*+.]/g, '');
                result = eval(safeEval);
            } catch(e) { result = "Error"; }

            // 4. Registrar en el Log Global
            const logEntry = {
                user: state.uname,
                formula: formula,
                result: Math.floor(result),
                details: diceDetails.join(' '),
                time: Date.now()
            };

            state.log.unshift(logEntry);
            if(state.log.length > 30) state.log.pop();
            sync();
        }

        // 7. CASILLAS PRO+
        async function transferLoot(text, cb) {
            if(!cb.checked) return;
            // Buscar dash del que el usuario es due√±o
            const myDash = Object.values(state.items).find(i => i.owner === state.uid);
            if(myDash) {
                state.items[myDash.id].content += `\n‚úÖ Recibido: ${text}`;
                cb.disabled = true;
                cb.parentElement.style.opacity = "0.5";
                sync();
            } else {
                alert("No tienes un Dash asignado. Usa el bot√≥n üë§ DUE√ëO en uno de tus Dashes primero.");
                cb.checked = false;
            }
        }

        // 8. UTILIDADES Y LOG
        function renderLog() {
            const content = document.getElementById('log-content');
            content.innerHTML = state.log.map(l => `
                <div class="log-row">
                    <b>${l.user}:</b> ${l.formula} ‚ûî <span style="color:var(--accent); font-size:14px;">${l.result}</span>
                    <span class="log-dice">${l.details}</span>
                </div>
            `).join('');
        }

        async function clearGlobalLog() {
            if(confirm("¬øReiniciar el log de dados para todos?")) {
                state.log = [];
                sync();
            }
        }

        function showModal(title, content) {
            const body = document.getElementById('modal-body');
            body.innerHTML = `<h2 style="color:var(--p); margin-top:0;">${title}</h2><div style="font-size:15px; color:#ddd;">${content}</div>`;
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        async function openOwnerMenu() {
            const body = document.getElementById('modal-body');
            let players = [];
            try { players = await OBR.party.getPlayers(); } catch(e) {}
            
            let html = `<h3>Asignar Propietario</h3><p style="font-size:11px; color:#888;">El due√±o recibe los items de las CasillasPro+</p>`;
            players.forEach(p => {
                html += `<button onclick="setOwner('${p.id}')" class="btn btn-p" style="width:100%; margin-bottom:5px;">${p.name}</button>`;
            });
            html += `<button onclick="setOwner('${state.uid}')" class="btn btn-ghost" style="width:100%;">Asignarme a m√≠</button>`;
            
            body.innerHTML = html;
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function setOwner(uid) {
            state.items[state.currentId].owner = uid;
            sync();
            document.getElementById('modal-overlay').style.display = 'none';
        }

        function closeDetails() {
            state.currentId = null;
            document.getElementById('view-details').style.display = 'none';
            document.getElementById('view-list').style.display = 'flex';
        }

        async function deleteCurrent() {
            if(confirm("¬øEliminar este Dash permanentemente?")) {
                delete state.items[state.currentId];
                state.currentId = null;
                sync();
                closeDetails();
            }
        }

        function ins(a, b) {
            const e = document.getElementById('editor');
            const s = e.selectionStart, end = e.selectionEnd;
            e.value = e.value.substring(0, s) + a + b + e.value.substring(end);
            saveContent();
        }

        function wrap(a, b) {
            const e = document.getElementById('editor');
            const s = e.selectionStart, end = e.selectionEnd;
            e.value = e.value.substring(0, s) + a + e.value.substring(s, end) + b + e.value.substring(end);
            saveContent();
        }

        init();
    </script>
</body>
</html>
