<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/@owlbear-rodeo/sdk"></script>
    <style>
        :root { --primary: #bb86fc; --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --accent: #03dac6; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; overflow-x: hidden; }
        h2 { color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 5px; margin-top: 0; }
        .menu-section { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        input, textarea { background: #2c2c2c; border: 1px solid #444; color: white; padding: 10px; border-radius: 6px; font-size: 14px; width: 100%; box-sizing: border-box; }
        button { background: var(--primary); color: black; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: opacity 0.2s; }
        button:hover { opacity: 0.8; }
        .dash-item { background: var(--card); padding: 12px; margin: 8px 0; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border: 1px solid #333; transition: transform 0.1s; }
        .dash-item:hover { border-color: var(--primary); transform: translateY(-2px); }
        .tab-bar { display: flex; gap: 5px; margin-bottom: 10px; overflow-x: auto; border-bottom: 1px solid #444; padding-bottom: 2px; }
        .tab { padding: 8px 16px; background: #333; cursor: pointer; border-radius: 8px 8px 0 0; font-size: 0.85em; white-space: nowrap; }
        .tab.active { background: var(--primary); color: black; font-weight: bold; }
        #preview-area { background: #1a1a1a; padding: 15px; border-radius: 8px; border: 1px dashed #555; min-height: 50px; margin-top: 10px; }
        .dice-roll { color: var(--primary); font-weight: bold; cursor: pointer; text-decoration: underline; background: rgba(187, 134, 252, 0.1); padding: 2px 6px; border-radius: 4px; }
        .result-box { background: #000; padding: 12px; border: 2px solid var(--accent); margin-top: 15px; border-radius: 8px; animation: slideIn 0.3s ease-out; }
        .stat-tag { color: var(--accent); font-weight: bold; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="app">
        <div id="view-list">
            <h2>Dashisboard+</h2>
            <div class="menu-section">
                <input type="text" id="dashName" placeholder="Nombre del nuevo Dash...">
                <button onclick="createDash()">+ Crear Nuevo Dash</button>
            </div>
            <div id="list-container"></div>
        </div>

        <div id="view-details" style="display:none;">
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 id="current-dash-title" style="margin:0; cursor:pointer;" onclick="showDashMenu()">Cargando...</h3>
                <button onclick="showList()" style="background:#444; color:white; padding: 5px 10px; font-size: 12px;">‚¨Ö Lista</button>
            </div>
            <div class="tab-bar" id="tab-bar"></div>
            <div style="display:flex; gap: 5px; margin-bottom: 10px;">
                <button onclick="addPage('normal')" style="font-size: 11px; background: #333; color: white;">+ P√°g. Normal</button>
                <button onclick="addPage('stats')" style="font-size: 11px; background: #333; color: var(--accent);">+ P√°g. Stats</button>
            </div>
            <textarea id="main-editor" rows="10" placeholder="Ej: FUE=10 o 1d20+FUE" oninput="handleInput()"></textarea>
            <div id="preview-area"></div>
            <div id="dice-output"></div>
        </div>
    </div>

    <script>
        const OBR = window.OBR;
        let state = { dashes: {}, currentId: null, currentPage: 0, stats: {} };

        // DETECCI√ìN DE ENTORNO: Owlbear o Navegador solo
        async function init() {
            if (window.location.hostname.includes("owlbear.rodeo") || window.parent !== window) {
                // Estamos en Owlbear
                OBR.onReady(async () => {
                    await refreshData();
                    OBR.scene.onMetadataChange(async () => await refreshData());
                });
            } else {
                // Estamos en navegador solo (Local Storage)
                console.log("Modo Test Navegador");
                const saved = localStorage.getItem("dash_test_data");
                if (saved) state.dashes = JSON.parse(saved);
                renderList();
            }
        }

        async function refreshData() {
            try {
                const meta = await OBR.scene.getMetadata();
                state.dashes = meta["com.dashisboard.data"] || {};
                renderList();
                if(state.currentId) renderDash();
            } catch(e) { console.error("Error al refrescar", e); }
        }

        async function save() {
            if (OBR.isReady) {
                await OBR.scene.setMetadata({ "com.dashisboard.data": state.dashes });
            } else {
                localStorage.setItem("dash_test_data", JSON.stringify(state.dashes));
                renderList(); 
                if(state.currentId) renderDash();
            }
        }

        function createDash() {
            const name = document.getElementById('dashName').value;
            if(!name) return;
            const id = "d-" + Date.now();
            state.dashes[id] = { name, pages: [{title: 'Principal', content: 'FUE=10\n1d20+FUE', type: 'stats'}] };
            document.getElementById('dashName').value = '';
            save();
        }

        function renderList() {
            const container = document.getElementById('list-container');
            container.innerHTML = '<h4>Tus Dashes:</h4>';
            Object.keys(state.dashes).forEach(id => {
                const item = document.createElement('div');
                item.className = 'dash-item';
                item.innerHTML = `<span>üìÇ ${state.dashes[id].name}</span>`;
                item.onclick = () => openDash(id);
                container.appendChild(item);
            });
        }

        function openDash(id) {
            state.currentId = id;
            state.currentPage = 0;
            document.getElementById('view-list').style.display = 'none';
            document.getElementById('view-details').style.display = 'block';
            renderDash();
        }

        function renderDash() {
            const dash = state.dashes[state.currentId];
            if(!dash) return showList();
            document.getElementById('current-dash-title').innerText = dash.name;
            const tabBar = document.getElementById('tab-bar');
            tabBar.innerHTML = '';
            dash.pages.forEach((p, i) => {
                const t = document.createElement('div');
                t.className = `tab ${state.currentPage === i ? 'active' : ''}`;
                t.innerText = (p.type === 'stats' ? 'üìä ' : 'üìÑ ') + p.title;
                t.onclick = () => { state.currentPage = i; renderDash(); };
                tabBar.appendChild(t);
            });
            const content = dash.pages[state.currentPage].content;
            document.getElementById('main-editor').value = content;
            parseContent(content);
        }

        function handleInput() {
            const val = document.getElementById('main-editor').value;
            state.dashes[state.currentId].pages[state.currentPage].content = val;
            parseContent(val);
            save();
        }

        function parseContent(text) {
            state.stats = {};
            const statRegex = /([A-Z√Å√â√ç√ì√ö]+)\s*=\s*(\d+)/gi;
            let match;
            while ((match = statRegex.exec(text)) !== null) {
                state.stats[match[1].toUpperCase()] = parseInt(match[2]);
            }
            let html = text.replace(/([A-Z√Å√â√ç√ì√ö]+)\s*=\s*(\d+)/gi, '<span class="stat-tag">$1=$2</span>');
            html = html.replace(/([0-9]*d[0-9]+(?:[\+\-\*\/][0-9A-Z√Å√â√ç√ì√ö\(\)]+)*)/gi, (f) => {
                return `<span class="dice-roll" onclick="roll('${f}')">${f}</span>`;
            });
            document.getElementById('preview-area').innerHTML = html.replace(/\n/g, '<br>');
        }

        function roll(formula) {
            let evalF = formula.toUpperCase();
            Object.keys(state.stats).forEach(s => {
                evalF = evalF.replace(new RegExp(`\\b${s}\\b`, 'g'), state.stats[s]);
            });
            const diceM = evalF.match(/(\d*)D(\d+)/i);
            if (!diceM) return;
            const n = parseInt(diceM[1]) || 1;
            const s = parseInt(diceM[2]);
            let rolls = [], sum = 0;
            for (let i = 0; i < n; i++) {
                const r = Math.floor(Math.random() * s) + 1;
                sum += r;
                rolls.push(`<span class="${r===s?'crit-success':(r===1?'crit-fail':'')}">${r}</span>`);
            }
            let total = sum;
            const math = evalF.replace(diceM[0], "");
            try { if (math.trim()) total = eval(sum + math.replace(/[^0-9\+\-\*\/\(\)\.]/g, '')); } catch(e) {}
            document.getElementById('dice-output').innerHTML = `<div class="result-box" onclick="this.innerHTML=''"><b>TOTAL: ${total}</b><br><small>[${rolls.join(', ')}] ${math}</small></div>`;
        }

        function showList() {
            state.currentId = null;
            document.getElementById('view-list').style.display = 'block';
            document.getElementById('view-details').style.display = 'none';
            renderList();
        }

        function addPage(type) {
            const title = prompt("Nombre p√°g:");
            if(!title) return;
            state.dashes[state.currentId].pages.push({ title, content: '', type });
            state.currentPage = state.dashes[state.currentId].pages.length - 1;
            save();
        }

        function showDashMenu() {
            const act = prompt("Escribe 'BORRAR' para eliminar o 'EDITAR' para renombrar:");
            if(act === 'BORRAR') { delete state.dashes[state.currentId]; save(); showList(); }
            if(act === 'EDITAR') { const n = prompt("Nuevo nombre:"); if(n) { state.dashes[state.currentId].name = n; save(); } }
        }

        init(); // Arrancar el sistema
    </script>
</body>
</html>
